<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.119.0">
    <meta name="generator" content="Relearn 5.22.1">
    <meta name="description" content="">
    <meta name="author" content="cagix">
    <title>Backend</title>
    <link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend.html" rel="canonical" type="text/html" title="Backend">

    
    

    <link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/images/logo.png?1697015446" rel="icon" type="image/png">

    <!-- https://github.com/filamentgroup/loadCSS/blob/master/README.md#how-to-use -->
    <link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/css/fontawesome-all.min.css?1697015446" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/css/fontawesome-all.min.css?1697015446" rel="stylesheet"></noscript>
    <link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/css/nucleus.css?1697015446" rel="stylesheet">
    <link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/css/auto-complete.css?1697015446" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/css/auto-complete.css?1697015446" rel="stylesheet"></noscript>
    <link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/css/perfect-scrollbar.min.css?1697015446" rel="stylesheet">
    <link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/css/fonts.css?1697015446" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/css/fonts.css?1697015446" rel="stylesheet"></noscript>
    <link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/css/theme.css?1697015446" rel="stylesheet">
    <link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/css/theme-auto.css?1697015446" rel="stylesheet" id="R-variant-style">
    <link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/css/variant.css?1697015446" rel="stylesheet">
    <link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/css/print.css?1697015446" rel="stylesheet" media="print">
    <link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/css/format-print.css?1697015446" rel="stylesheet">
    <link href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/css/ie.css?1697015446" rel="stylesheet">
    <script src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/js/url.js?1697015446"></script>
    <script src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/js/variant.js?1697015446"></script>
    <script>
      // hack to let hugo tell us how to get to the root when using relativeURLs, it needs to be called *url= for it to do its magic:
      // https://github.com/gohugoio/hugo/blob/145b3fcce35fbac25c7033c91c1b7ae6d1179da8/transform/urlreplacers/absurlreplacer.go#L72
      window.index_js_url="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/index.search.js";
      var root_url="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/";
      var baseUri=root_url.replace(/\/$/, '');
      // translations
      window.T_Copy_to_clipboard = 'Copy to clipboard';
      window.T_Copied_to_clipboard = 'Copied to clipboard!';
      window.T_Copy_link_to_clipboard = 'Copy link to clipboard';
      window.T_Link_copied_to_clipboard = 'Copied link to clipboard!';
      window.T_Reset_view = 'Reset view';
      window.T_View_reset = 'View reset!';
      window.T_No_results_found = 'No results found for \u0022{0}\u0022';
      window.T_N_results_found = '{1} results found for \u0022{0}\u0022';
      // some further base stuff
      var baseUriFull='https:\/\/www.hsbi.de\/elearning\/data\/FH-Bielefeld\/lm_data\/lm_1371719/';
      window.variants && variants.init( [ 'auto', 'zen-light', 'zen-dark', 'relearn-bright', 'relearn-light', 'relearn-dark' ] );
    </script><style type="text/css">

 
.center {
    align-content: center;
    text-align: center;
    margin: auto;
}
.alert {
    color: #ff3333;
}
.bsp {
    padding: 0.05cm;
    border-width: 0.05cm;
    border-style: solid;
    border-color: #ddd;
    background-color: #ddd;
    border-radius: 25px;
    float: right;
}
.cbox {
    padding: 0.2cm;
    border-width: 0.1cm;
    border-style: solid;
    border-color: #4070a0;
    background-color: #f2f2f2;
    margin: auto;
    width: 60%;
    text-align: center;
    overflow: auto;
}
.blueArrow {
    color: #4070a0;
    font-family: "Courier New", "Courier", monospace;
    font-weight: bold;
}
.origin {
    background-color: #ededed;
    font-size: 0.8em;
}
.showme {
    background-color: #ededed;
    font-size: 0.8em;
}


 
.tldr {
    background: #dbe4ed;
    padding: 12px;
    margin: 4px 0px 26px 0px;
}
.recap {
    
    
   margin: 4px 0px 26px 0px;
}
.bib {
    background: #dbe4ed;
    padding: 12px;
    margin: 4px 0px 26px 0px;
}
.outcomes {
    background: #d9e9d5;
    padding: 12px;
    margin: 4px 0px 26px 0px;
}
.quizzes {
    background: #d9e9d5;
    padding: 12px;
    margin: 4px 0px 26px 0px;
}
.challenges {
    background: #ebe4d6;
    padding: 12px;
    margin: 4px 0px 26px 0px;
}
.assignments {
    background: #ebe4d6;
    padding: 12px;
    margin: 4px 0px 26px 0px;
}
h1.tldr, h1.recap, h1.bib, h1.outcomes, h1.quizzes, h1.challenges, h1.assignments {
    padding: 0px;
}


 
.noJsAlert {
    padding: 20px;
    background-color: #f44336;  
    color: white;
    margin-bottom: 15px;
}


 
.embed-video-player {
    position: relative;
    padding-bottom: 56%;
    height: 0;
    overflow: hidden;
}
.youtube-player {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border:0;
}


 
#header-wrapper {
    padding:0.6rem;
}


 
#shortcuts {
    padding-top: 2.0rem;
}


 
#chapter p {
    text-align: left;
}


 
figcaption h4 {
    margin-top:-2.5rem;
}
.border1 {
    border:1px solid black;
}

 
td ul, td ol {
    margin: 0 0 1rem 0.5rem;
    padding: 0 0 0 0.5rem;
}

 
h1 { font-size:2.8rem !important;}
h2 { font-size:2.2rem; margin:1.2rem 0}
h3 { font-size:1.9rem; text-align:left !important; font-weight:400 !important;}
h4 { font-size:1.6rem}
h5 { font-size:1.3rem}
h6 { font-size:1rem}

h2 {
    width:100% !important;
    border-bottom:1px solid #5e5e5e !important;
    padding-bottom: 2px;
}
.tldr h2, .recap h2, .bib h2, .outcomes h2, .quizzes h2, .challenges h2, .assignments h2 {
    margin:0.5rem 0
}

.btn-crossreference, .btn-crossreference:hover {
    cursor: initial;
}

</style>

  </head>
  <body class="mobile-support print disableInlineCopyToClipboard" data-url="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide">
              <button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)">
                <i class="fa-fw fas fa-bars"></i>
              </button>
            </div>
          </div>
          <span class="topbar-breadcrumbs highlightable">
            Backend
          </span>
          <div class="topbar-area topbar-area-end" data-area="end">
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="default">
            <header class="headline">
            </header>
<h1 id="backend">Backend</h1>

<p>Unter dem &quot;Backend&quot; versteht man die hinteren Stufen eines Compilers,
die mit der <strong>Synthese</strong> der Ausgabe besch√§ftigt sind. Dies sind in
der Regel verschiedene Optimierungen und letztlich die Code-Generierung</p>

<ul class="children children-li children-sort-">
	
<li><a href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/optimization.html">Optimierung und Datenflussanalyse</a></li>
<li><a href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation.html">Interpreter</a></li>
<li><a href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/machinecode.html">Generierung von Maschinencode (Skizze)</a></li>
</ul>

            <footer class="footline"><div style="color: darkgray; font-size: small;">
<p style="margin: 4rem;">
<!-- https://creativecommons.org/choose/ -->
<a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0;margin:0;display:inline;" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
Unless otherwise noted, <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master">this work</a> by <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/bcg7" property="cc:attributionName" rel="cc:attributionURL">BC George</a>, <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/cagix" property="cc:attributionName" rel="cc:attributionURL">Carsten Gips</a>, and <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/graphs/contributors">contributors</a> is licensed under <a rel="license" href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/LICENSE.md">CC BY-SA 4.0</a>.
See the <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/CREDITS.md">credits</a> for a detailed list of contributing projects.

</p>
</div>

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Backend</h1>
<article class="default">
<h1>Optimierung und Datenflussanalyse</h1>



    
    




    
    
        
        
            
            
                
            
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="far fa-file-powerpoint"></i> Annotierte Folien</div>
  <div class="box-content">

<ul> <li><a href='https://raw.githubusercontent.com/Compiler-CampusMinden/AnnotatedSlides/master/optimization.ann.ma.pdf' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>Annotierte Folien: Optimierung und Datenflussanalyse</a></li></ul></div>
</div>




    <h1 id="motivation">Motivation</h1>
<h2 id="was-geschieht-hier">Was geschieht hier?</h2>
<pre><code>01  {
02    var a;
03    var b = 2;
04    b = a;
05  }
</code></pre>
<h1 id="zwischencode-ist-eine-gute-idee">Zwischencode ist eine gute Idee</h1>
<h2 id="eine-sprache-viele-maschinen-vs-viele-sprachen-eine-maschine">Eine Sprache, viele Maschinen vs. viele Sprachen, eine Maschine</h2>
<p>Hier entsteht ein Tafelbild.</p>
<h2 id="-und-beides-zusammen">... und beides zusammen?</h2>
<p>Hier entsteht ein Tafelbild.</p>
<h2 id="zwischencode-intermediate-code-hier-drei-adress-code">Zwischencode (intermediate code); hier: Drei-Adress-Code</h2>
<ul>
<li>registerbasiert</li>
<li>Formen: <code>x = y op z, x = op z, x = y</code></li>
<li>tempor√§re Variablen f√ºr Zwischenergebnisse</li>
<li>bedingte und unbedingte Spr√ºnge</li>
<li>Pointerarithmetik f√ºr Indizierung</li>
</ul>
<div class='columns'>
<div class='column'>
<pre><code>i = 0
while(f[i] &gt; 100)
    i = i + 1;
</code></pre>
</div>
<div class='column'>
<pre><code>    i = 0
L1: t1 = i * 8
    t2 = f + t1
    if t2 &lt;= 100 goto L2
    t3 = i + 1
    i = t3
    goto L1
L2: ...
</code></pre>
</div>
</div>
<h1 id="optimierungen">Optimierungen</h1>
<h2 id="was-ist-optimierung-in-compilern">Was ist Optimierung in Compilern?</h2>
<p>Ver√§ndern von Quellcode, Zwischencode oder Maschinencode eines Programms mit dem Ziel,</p>
<ul>
<li>Laufzeit,</li>
<li>Speicherplatz oder</li>
<li>Energieverbrauch</li>
</ul>
<p>zu verbessern.</p>
<h2 id="was-ist-machbar">Was ist machbar?</h2>
<p>Manche Optimierungen machen den Code nur in bestimmten F√§llen schneller, kleiner oder stromsparender.</p>
<p>Den optimalen Code zu finden, ist oft NP-vollst√§ndig oder sogar unentscheidbar.</p>
<ul>
<li>
<p>Heuristiken kommen zum Einsatz.</p>
</li>
<li>
<p>Der Code wird verbessert, nicht in jedem Fall optimiert, manchmal auch verschlechtert.</p>
</li>
<li>
<p>Der Einsatz eines Debuggers ist meist nicht mehr m√∂glich.</p>
</li>
</ul>
<h2 id="anforderungen-an-optimierung">Anforderungen an Optimierung</h2>
<ul>
<li>
<p>sichere Transformationen durchf√ºhren</p>
</li>
<li>
<p>m√∂glichst keine nachteiligen Effekte erzeugen</p>
</li>
</ul>
<h2 id="optimierung-zur-√ºbersetzungszeit-vs-optimierung-zur-laufzeit">Optimierung zur √úbersetzungszeit vs. Optimierung zur Laufzeit</h2>
<ul>
<li>
<p>Just-in-time-Compilierung (JIT), z. B. Java:</p>
<p>Fast alle Optimierungsma√ünahmen finden in der virtuellen Maschine zur Laufzeit statt.</p>
</li>
<li>
<p>Ahead-of-time-Compilierung (AOT), z. B. C:</p>
<p>Der Compiler erzeugt Maschinencode, die Optimierung findet zur √úbersetzungszeit statt.</p>
</li>
</ul>
<p>Beide haben ihre eigenen Optimierungsm√∂glichkeiten, es gibt aber auch Methoden, die bei beiden einsetzbar sind.</p>
<h2 id="welcher-code-wird-optimiert">Welcher Code wird optimiert?</h2>
<ul>
<li>
<p>Algebraische Optimierung:
Transformationen des Quellcodes</p>
</li>
<li>
<p>Maschinenunabh√§ngige Optimierung:
Transformationen des Zwischencodes</p>
</li>
<li>
<p>Maschinenabh√§ngige Optimierung:
Transformationen des Assemblercodes oder Maschinencodes</p>
</li>
</ul>
<p>Viele Transformationen sind auf mehr als einer Ebene m√∂glich. Wir wenden hier die meisten auf den Zwischencode an.</p>
<h2 id="welche-arten-von-transformationen-sind-m√∂glich">Welche Arten von Transformationen sind m√∂glich?</h2>
<ul>
<li>
<p>Eliminierung unn√∂tiger Berechnungen</p>
</li>
<li>
<p>Ersetzung von teuren Operationen durch kosteng√ºnstigere</p>
</li>
</ul>
<h2 id="basisbl√∂cke-und-flussgraphen">Basisbl√∂cke und Flussgraphen</h2>
<p><strong>Def.:</strong> Ein <em>Basisblock</em> ist eine Sequenz maximaler L√§nge von Anweisungen, die immer hintereinander ausgef√ºhrt werden.</p>
<p>Ein Sprungbefehl kann nur der letzte Befehl eines Basisblocks sein.</p>
<p><strong>Def.:</strong> Ein <em>(Kontroll)Flussgraph</em> 
<span class="math align-center">$G = (V, E)$</span> ist ein Graph mit</p>
<p>
<span class="math align-center">$V = \lbrace B_i \ \vert \ B_i \text{ ist ein Basisblock des zu compilierenden Programms} \rbrace$</span>,</p>

<span class="math align-center">$E = \lbrace (B_i, B_j)\ \vert \text{ es gibt einen Programmlauf, in dem } B_j \text{ direkt hinter } B_i \text{ ausgef√ºhrt wird} \rbrace$</span>
<h2 id="h√§ufig-benutzte-strategie-peephole-optimierung">H√§ufig benutzte Strategie: Peephole-Optimierung</h2>
<p>Ein Fenster mit wenigen Zeilen Inhalt gleitet √ºber den Quellcode, Zwischencode oder den Maschinencode. Der jeweils sichtbare Code wird mit Hilfe verschiedener Verfahren optimiert, wenn m√∂glich.</p>
<p>Peephole-Optimierung ist zun√§chst ein lokales Verfahren, kann aber auch auf den gesamten Kontrollflussgraphen erweitert werden.</p>
<p>=&gt;
Anwendung von Graphalgorithmen!</p>
<h1 id="algebraische-optimierung">Algebraische Optimierung</h1>
<h2 id="ersetzen-von-teilb√§umen-im-ast-durch-andere-b√§ume">Ersetzen von Teilb√§umen im AST durch andere B√§ume</h2>
<pre><code>    x = x*2         =&gt;      x &lt;&lt; 1

    x = x + 0       // k.w.
    x = x * 1       // k.w.

    x = x*0         =&gt;      x = 0
    x = x*8         =&gt;      x = x &lt;&lt; 3
</code></pre>
<p>Sei 
<span class="math align-center">$s = 2^a + 2^b$</span> die Summe zweier Zweierpotenzen:</p>
<pre><code>    x = n*s         =&gt;      (n &lt;&lt; a) + (n &lt;&lt; b)
</code></pre>
<p>Diese Umformungen k√∂nnen zus√§tzlich mittels Peephole-Optimierung in sp√§teren Optimierungsphasen durchgef√ºhrt werden.</p>
<h1 id="maschinenunabh√§ngige-optimierung">Maschinenunabh√§ngige Optimierung</h1>
<h2 id="maschinenunabh√§ngige-optimierung-1">Maschinenunabh√§ngige Optimierung</h2>
<ul>
<li>
<p>lokal (= innerhalb eines Basisblocks), z. B. Peephole-Optimierung</p>
<p>Einige Strategien sind auch global einsetzbar (ohne die sog. Datenflussanalyse s. u.)</p>
</li>
<li>
<p>global, braucht nicht-lokale Informationen</p>
<ul>
<li>meist unter Zuhilfenahme der Datenflussanalyse</li>
<li>Schleifenoptimierung</li>
</ul>
</li>
</ul>
<h1 id="lokale-optimierung">Lokale Optimierung</h1>
<h2 id="constant-folding-und-common-subexpression-elimination">Constant Folding und Common Subexpression elimination</h2>
<ul>
<li>
<p>&quot;<em>Constant Folding</em>&quot;: Auswerten von Konstanten zur Compile-Zeit</p>
<pre><code>x = 6 * 7         =&gt;      x = 42
if 2 &gt; 0 jump L   =&gt;      jump L
</code></pre>
</li>
<li>
<p>&quot;<em>Common Subexpression Elimination</em>&quot;</p>
<div class='columns'>
<div class='column'>
<pre><code>x = y + z
...
a = y + z
</code></pre>
</div>
<div class='column'>
<p>ersetze mit (falls in <code>...</code> keine weiteren Zuweisungen an <code>x</code>, <code>y</code>, <code>z</code> erfolgen)</p>
</div>
<div class='column'>
<pre><code>x = y + z
...
a = x
</code></pre>
</div>
</div>
</li>
</ul>
<h2 id="elimination-redundanter-berechnungen-in-einem-basisblock-mitels-dags">Elimination redundanter Berechnungen in einem Basisblock mitels DAGs</h2>
<p>Hier werden sog. <em>DAG</em>s ben√∂tigt:</p>
<p>Ein DAG <em>directed acyclic graph</em> ist ein gerichteter, kreisfreier Graph.</p>
<p>DAGs werden f√ºr Berechnungen in Basisbl√∂cken generiert, um gemeinsame Teilausdr√ºcke zu erkennen.</p>
<p><em>Bsp.:</em> a = (b + c) * (b + c) / 2</p>
<h2 id="copy-propagation">Copy propagation</h2>
<ul>
<li>
<p>&quot;<em>Copy Propagation</em>&quot;</p>
<div class='columns'>
<div class='column'>
<pre><code>x = y + z
a = x
b = 2*a
</code></pre>
</div>
<div class='column'>
<p>ersetze mit</p>
</div>
<div class='column'>
<pre><code>x = y + z
a = x
b = 2*x
</code></pre>
</div>
</div>
</li>
</ul>
<p>Wenn auf <em>a</em> vor seiner n√§chsten Zuweisung nicht mehr lesend zugegriffen wird, kann <em>a</em> hier entfallen.</p>
<h1 id="globale-optimierung">Globale Optimierung</h1>
<h2 id="control-flow-und-dead-code">Control Flow und Dead Code</h2>
<ul>
<li>
<p>Kontrollfluss-Optimierungen</p>
<pre><code>    if debug == 1 goto L1           if debug != 1 goto L2
    goto L2                         print debug info
L1: print debug info            L2: ...
L2: ...
</code></pre>
</li>
<li>
<p>Elimination of unreachable code</p>
<pre><code>     goto L1                        L1: a = b+c
     ...
 L1: a = b+c
</code></pre>
</li>
</ul>
<h2 id="schleifenoptimierung">Schleifenoptimierung</h2>
<p>Loop unrolling:</p>
<pre><code>        for i = 1 to 3                  print(&quot;1&quot;)
            print(i)                    print(&quot;2&quot;)
                                        print(&quot;3&quot;)
</code></pre>
<p>Code Hoisting:</p>
<ul>
<li>
<p>Invarianten vor die Schleife schieben</p>
<pre><code>   x = 0                           x = 0
L: a = n*7                         a = n*7
   x = x + a                    L: x = x + a
   if x&lt;42 jump L                  if x&lt;42 jump L
</code></pre>
</li>
</ul>
<h2 id="kombination-zweier-verfahren">Kombination zweier Verfahren</h2>
<ul>
<li>
<p>Loop Unrolling (f√ºr eine Iteration), danach Common Subexpression Elimination</p>
<pre><code>while (cond) {                  if (cond) {
    body                            body
}                                   while (cond) {
                                        body
                                    }
                                }
</code></pre>
</li>
</ul>
<h2 id="datenflussanalyse">Datenflussanalyse</h2>
<p>Die Datenflussanalyse (auf 3-Adress-Code) basiert auf dem Wissen der Verf√ºgbarkeit von Variablen und Ausdr√ºcken am Anfang oder Ende von Basisbl√∂cken, und zwar f√ºr alle m√∂glichen Programml√§ufe.</p>
<p>Man unterscheidet:</p>
<ul>
<li>
<p>Vorw√§rtsanalyse (in Richtung der Nachfolger eines Basisblocks)</p>
</li>
<li>
<p>R√ºckw√§rtsanalyse (in Richtung der Vorg√§nger eines Basisblocks)</p>
</li>
</ul>
<p>In beiden F√§llen gibt es zwei Varianten:</p>
<ul>
<li>
<p>any analysis: Es wird die Vereinigung von Informationen benachbarter Block ber√ºcksichtigt.</p>
</li>
<li>
<p>all analysis: Es wird die Schnittmenge von Informationen benachbarter Block ber√ºcksichtigt.</p>
</li>
</ul>
<h2 id="forward-any-analysis">Forward-any-analysis</h2>
<p>Diese Analyse wird zur Propagation von Konstanten und Variablen benutzt und bildet sukzessive Mengen von Zeilen mit Variablendefinitionen.</p>

<span class="math align-center">$$out(B_i) = gen(B_i) \cup (in(B_i) - kill(B_i))$$</span>
<p>
<span class="math align-center">$out(B_i)$</span>: alle Zeilennummern von Variablendefinitionen, die am Ende von 
<span class="math align-center">$B_i$</span> g√ºltig sind</p>
<p>
<span class="math align-center">$in(B_i)$</span>: alle Zeilennummern von Variablendefinitionen, die am Ende von Vorg√§ngerbl√∂cken von 
<span class="math align-center">$B_i$</span> g√ºltig sind</p>
<p>
<span class="math align-center">$gen(B_i)$</span>: alle Zeilennummern von letzten Variablendefinitionen in 
<span class="math align-center">$B_i$</span></p>
<p>
<span class="math align-center">$kill(B_i)$</span>: alle Zeilennummern von Variablendefinitionen au√üerhalb von 
<span class="math align-center">$B_i$</span>, die in 
<span class="math align-center">$B_i$</span> √ºberschrieben werden</p>
<p>Zun√§chst ist 
<span class="math align-center">$in(B_1) = \emptyset$</span>, danach ist 
<span class="math align-center">$in(B_i) = \bigcup out(B_j)$</span> mit 
<span class="math align-center">$B_j$</span> ist Vorg√§nger von 
<span class="math align-center">$B_i$</span>.</p>
<h2 id="forward-all-analysis">Forward-all-analysis</h2>
<p>Diese Analyse wird zur Berechnung verf√ºgbarer Ausdr√ºcke der Form 
<span class="math align-center">$x = y\ op\ z$</span> f√ºr die Eliminierung redundanter Berechnungen benutzt und bildet sukzessive Mengen von Ausdr√ºcken.</p>

<span class="math align-center">$$out(B_i) = gen(B_i) \cup (in(B_i) - kill(B_i))$$</span>
<p>
<span class="math align-center">$out(B_i)$</span>: alle am Ende von 
<span class="math align-center">$B_i$</span> verf√ºgbaren Ausdr√ºcke</p>
<p>
<span class="math align-center">$in(B_i)$</span>: alle Ausdr√ºcke, die am Anfang von 
<span class="math align-center">$B_i$</span> verf√ºgbar sind</p>
<p>
<span class="math align-center">$gen(B_i)$</span>: alle in 
<span class="math align-center">$B_i$</span> berechneten Ausdr√ºcke</p>
<p>
<span class="math align-center">$kill(B_i)$</span>: alle Ausdr√ºcke 
<span class="math align-center">$x\ op\ y$</span> mit einer Definition von 
<span class="math align-center">$x$</span> oder 
<span class="math align-center">$y$</span> in 
<span class="math align-center">$B_i$</span> und 
<span class="math align-center">$x\ op\ y$</span> ist nicht in 
<span class="math align-center">$B_i$</span></p>
<p>Zun√§chst ist 
<span class="math align-center">$gen(B_1) = \emptyset$</span>, danach ist 
<span class="math align-center">$in(B_i) = \bigcap out(B_j)$</span> mit 
<span class="math align-center">$B_j$</span> ist Vorg√§nger von 
<span class="math align-center">$B_i$</span>.</p>
<h2 id="backward-any-analysis">Backward-any-analysis</h2>
<p>Diese Analyse dient der Ermittlung von lebenden und toten Variablen (f√ºr die Registerzuweisung) und bildet sukzessive Mengen von Variablen.</p>

<span class="math align-center">$$in(B_i) = gen(B_i) \cup (out(B_i) - kill(B_i))$$</span>
<p>
<span class="math align-center">$out(B_i)$</span>: alle Variablen, die am Ende von 
<span class="math align-center">$B_i$</span> lebendig sind</p>
<p>
<span class="math align-center">$in(B_i)$</span>: alle Variablen, die am Ende von Vorg√§ngerbl√∂cken von 
<span class="math align-center">$B_i$</span> lebendig sind</p>
<p>
<span class="math align-center">$gen(B_i)$</span>: alle Variablen, deren erstes Vorkommen auf der echten Seite einer Zuweisung steht</p>
<p>
<span class="math align-center">$kill(B_i)$</span>: alle Variablen, denen in 
<span class="math align-center">$B_i$</span> Werte zugewiesen werden.</p>
<p>Zun√§chst ist 
<span class="math align-center">$out(B_n) = \emptyset$</span>, danach ist 
<span class="math align-center">$out(B_i) = \bigcup in(B_j)$</span> mit 
<span class="math align-center">$B_j$</span> ist Nachfolger von 
<span class="math align-center">$B_i$</span>.</p>
<h2 id="backward-all-analysis">Backward-all-analysis</h2>
<p>Diese Analyse wird zur Berechnung von &quot;very busy&quot; Ausdr√ºcken der Form 
<span class="math align-center">$x = y\ op\ z$</span>, die auf allen m√∂glichen Wegen im Flussgraphen vom aktuellen Basisblock aus mindestens einmal benutzt werden. Ausdr√ºcke sollten dort berechnet werden, wo sie very busy sind, um den Code k√ºrzer zu machen.</p>

<span class="math align-center">$$in(B_i) = gen(B_i) \cup (out(B_i) - kill(B_i))$$</span>
<p>
<span class="math align-center">$out(B_i)$</span>: alle Ausdr√ºcke 
<span class="math align-center">$x\ op\ y$</span>, die am Ende von 
<span class="math align-center">$B_i$</span> very busy sind</p>
<p>
<span class="math align-center">$in(B_i)$</span>: alle Ausdr√ºcke, die am Anfang von 
<span class="math align-center">$B_i$</span> very busy sind</p>
<p>
<span class="math align-center">$gen(B_i)$</span>: alle in 
<span class="math align-center">$B_i$</span> benutzen Ausdr√ºcke</p>
<p>
<span class="math align-center">$kill(B_i)$</span>: alle Ausdr√ºcke 
<span class="math align-center">$x\ op\ y$</span>, deren Operanden in 
<span class="math align-center">$B_i$</span> nicht redefiniert werden.</p>
<p>Zun√§chst ist 
<span class="math align-center">$out(B_n) = \emptyset$</span>, danach ist 
<span class="math align-center">$out(B_i) = \bigcap in(B_j)$</span> mit 
<span class="math align-center">$B_j$</span> ist Nachfolger von 
<span class="math align-center">$B_i$</span>.</p>
<h1 id="maschinenabh√§ngige-optimierung">Maschinenabh√§ngige Optimierung</h1>
<h2 id="elimination-redundanter-lade--speicher--und-sprungoperationen">Elimination redundanter Lade-, Speicher- und Sprungoperationen</h2>
<pre><code>    LD a, R0
    ST R0, a        // k.w.

        goto L1         goto L2
        ...             ...
    L1: goto L2     L1: goto L2
</code></pre>
<h2 id="register-allocation-liveness-analysis">Register Allocation: Liveness Analysis</h2>
<div class='columns'>
<div class='column'>
<pre><code>a = b + c
d = a + b
e = d - 1
</code></pre>
</div>
<div class='column'>
<p><code>a</code>, <code>d</code>, <code>e</code> k√∂nnen auf <strong>ein</strong> Register abgebildet werden!</p>
<pre><code>r1 = r2 + r3
r1 = r1 + r2
r1 = r1 - 1
</code></pre>
</div>
</div>
<p>=&gt; <code>a</code> und <code>d</code> sind nach Gebrauch &quot;<em>tot</em>&quot;</p>
<h2 id="berechnung-der-minimal-ben√∂tigten-anzahl-von-registern">Berechnung der minimal ben√∂tigten Anzahl von Registern</h2>
<p>=&gt; Liveness-Graph, F√§rbungsproblem f√ºr Graphen!</p>
<p>Es wird ein Graph 
<span class="math align-center">$G = (V, E)$</span> erzeugt mit</p>
<p>
<span class="math align-center">$V = \lbrace v \ \vert \ v \text{ ist eine ben√∂tigte Variable} \rbrace$</span> und

<span class="math align-center">$E = \lbrace (v_1, v_2)\ \vert \ v_1 \text{ und } v_2 \text{ sind zur selben Zeit "lebendig"} \rbrace$</span></p>
<p>Heuristisch wird jetzt die minimale Anzahl von Farben f√ºr Knoten bestimmt, bei der benachbarte Knoten nicht dieselbe Farbe bekommen.</p>
<p>=&gt; Das Ergebnis ist die Zahl der ben√∂tigten Register.</p>
<h2 id="und-wenn-man-nicht-so-viele-register-zur-verf√ºgung-hat">Und wenn man nicht so viele Register zur Verf√ºgung hat?</h2>
<p>Registerinhalte tempor√§r in den Speicher auslagern (&quot;<em>Spilling</em>&quot;).</p>
<p>Kandidaten daf√ºr werden mit Heuristiken gefunden, z. B. Register mit vielen Konflikten (= Kanten) oder Register mit selten genutzten Variablen.</p>
<p>In Schleifen genutzte Variablen werden eher nicht ausgelagert.</p>
<h1 id="optimierung-zur-reduzierung-des-energieverbrauchs">Optimierung zur Reduzierung des Energieverbrauchs</h1>
<h2 id="energieverbrauch-verschiedener-maschinenbefehle">Energieverbrauch verschiedener Maschinenbefehle</h2>
<p>Maschinenoperationen, die nur auf Registern arbeiten, verbrauchen die wenigste Energie.</p>
<p>Operationen, die nur lesend auf Speicherzellen zugreifen, verbrauchen ca. ein Drittel mehr Energie.</p>
<p>Operationen, die Speicherzellen beschreiben, ben√∂tigen zwei Drittel mehr Energie als die Operationen ausschlie√ülich auf Register.</p>
<h2 id="energieeinsparung-durch-laufzeitbezogene-optimierung">Energieeinsparung durch laufzeitbezogene Optimierung</h2>
<p>K√ºrzere Programmlaufzeiten f√ºhren in der Regel auch zu Energieeinsparungen.</p>
<p><strong>gcc -O1</strong> spart 2% bis 70% (durchschnittlich 20%) Energie</p>
<p>Umgekehrt: Energiebezogene Optimierung f√ºhrt in der Regel zu k√ºrzeren Laufzeiten.</p>
<h2 id="prozessorspannung-variieren">Prozessorspannung variieren</h2>
<p>Viele Prozessoren erm√∂glichen es, die Betriebsspannung per Maschinenbefehl zu ver√§ndern.</p>
<p>Eine h√∂here Spannung bewirkt eine proportionale Steigerung der Prozessorgeschwindigkeit und des flie√üenden Stroms, aber einen quadratischen Anstieg des Energieverbrauchs. 
<span class="math align-center">$(P = U \times I, U = R \times I)$</span></p>
<p>Folgendes kann man ausnutzen:</p>
<p>Die Verringerung der Spannung um 20% f√ºhrt zu einer um 20% geringeren Prozessorgeschwindigkeit, d. h. das Programm braucht 25% mehr Zeit, verbraucht aber 36% 
<span class="math align-center">$(1-(1-0,2)^2)$</span> weniger Energie.</p>
<p>=&gt; Wenn das Programm durch Optimierung um 25% schneller wird und die Prozessorspannung um 20% verringert wird, ver√§ndert sich die Laufzeit des Programms nicht, man spart aber 36% Energie.</p>
<h1 id="wrap-up">Wrap-Up</h1>
<h2 id="wrap-up-1">Wrap-Up</h2>
<ul>
<li>Verschiedene Optimierungsverfahren auf verschiedenen Ebenen, Peephole</li>
<li>Datenflussanalyse</li>
<li>Senkung des Energieverbrauchs durch Optimierung</li>
</ul>


    




    
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
            
            
                
            
            
        
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
            
            
                
            
            
        
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
            
            
                
            
            
        
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
                    
                
            
            
                
            
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-book-reader"></i> Quellen</div>
  <div class="box-content">

<ul> <li id='id_Aho2008'>[Aho2008] <strong>Compiler: Prinzipien, Techniken und Werkzeuge</strong><br>Aho, A. V. und Lam, M. S. und Sethi, R. und Ullman, J. D., Pearson Studium, 2008. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-3-8273-7097-6' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-3-8273-7097-6</a>.<br><em>Kapitel 9</em></li> <li id='id_Grune2012'>[Grune2012] <strong>Modern Compiler Design</strong><br>Grune, D. und van, Reeuwijk, K. und Bal, H. E. und Jacobs, C. J. H. und Langendoen, K., Springer, 2012. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-1-4614-4698-9' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-1-4614-4698-9</a>.<br><em>Kapitel 9.3</em></li> <li id='id_G√ºting1999'>[G√ºting1999] <strong>√úbersetzerbau: Techniken, Werkzeuge, Anwendungen</strong><br>G√ºting, R. H., Springer, 1999. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-3-5406-5389-9' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-3-5406-5389-9</a>.<br><em>Kapitel 8</em></li> <li id='id_Mogensen2017'>[Mogensen2017] <strong>Introduction to Compiler Design</strong><br>Mogensen, T., Springer, 2017. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-3-319-66966-3' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-3-319-66966-3</a>. DOI <a href='https://doi.org/10.1007/978-3-319-66966-3' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>10.1007/978-3-319-66966-3</a>.<br><em>Kapitel 8, 10 und 11</em></li></ul></div>
</div>



    

    

    
    
        
        
        
        
    
        
        
        
        
    
        
        
        
        
    
        
        
        
        
    
    

    
<div class="box notices cstyle tip">
  <div class="box-label"><i class="fas fa-lightbulb"></i> Lernziele</div>
  <div class="box-content">

<ul> <li>(K1) Algebraische Optimierungen</li> <li>(K1) Maschinenunabh√§ngige Optimierungen</li> <li>(K1) Maschinenabh√§ngige Optimierungen</li> <li>(K1) Datenflussanalyse auf 3-Adress-Code</li></ul></div>
</div>



    








<footer class="footline"><div style="color: darkgray; font-size: small;">
<p style="margin: 4rem;">
<!-- https://creativecommons.org/choose/ -->
<a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0;margin:0;display:inline;" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
Unless otherwise noted, <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master">this work</a> by <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/bcg7" property="cc:attributionName" rel="cc:attributionURL">BC George</a>, <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/cagix" property="cc:attributionName" rel="cc:attributionURL">Carsten Gips</a>, and <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/graphs/contributors">contributors</a> is licensed under <a rel="license" href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/LICENSE.md">CC BY-SA 4.0</a>.
See the <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/CREDITS.md">credits</a> for a detailed list of contributing projects.

</p>
</div>

</footer>
</article>

          <article class="default">
            <header class="headline">
            </header>
<h1 id="interpreter">Interpreter</h1>

<p>Ein Interpreter erzeugt keinen Code, sondern f√ºhrt Source-Code (interaktiv) aus. Die einfachste
M√∂glichkeit ist der Einsatz von attributierten Grammatiken, wo der Code bereits beim Parsen
ausgef√ºhrt wird. Mehr M√∂glichkeiten hat man dagegen bei der Traversierung des AST, beispielsweise
mit dem Visitor-Pattern. (Register- und Stack-basierte Interpreter betrachten wir im Rahmen der
Veranstaltung aktuell nicht.)</p>

<ul class="children children-li children-sort-">
	
<li><a href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/syntaxdriven.html">Syntaxgesteuerte Interpreter</a></li>
<li><a href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/astdriven-part1.html">AST-basierte Interpreter: Basics</a></li>
<li><a href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/astdriven-part2.html">AST-basierte Interpreter: Funktionen und Klassen</a></li>
<li><a href="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/gc.html">Garbage Collection</a></li>
</ul>

            <footer class="footline"><div style="color: darkgray; font-size: small;">
<p style="margin: 4rem;">
<!-- https://creativecommons.org/choose/ -->
<a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0;margin:0;display:inline;" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
Unless otherwise noted, <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master">this work</a> by <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/bcg7" property="cc:attributionName" rel="cc:attributionURL">BC George</a>, <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/cagix" property="cc:attributionName" rel="cc:attributionURL">Carsten Gips</a>, and <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/graphs/contributors">contributors</a> is licensed under <a rel="license" href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/LICENSE.md">CC BY-SA 4.0</a>.
See the <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/CREDITS.md">credits</a> for a detailed list of contributing projects.

</p>
</div>

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Interpreter</h1>
<article class="default">
<h1>Syntaxgesteuerte Interpreter</h1>



    



    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-graduation-cap"></i> TL;DR</div>
  <div class="box-content">

<p>Zur Einordnung noch einmal die bisher betrachteten Phasen und die jeweiligen Ergebnisse:</p>
<p><a href="#R-image-09ae296b742993885c9a8437a9126081" class="lightbox-link"><img src="images/architektur_cb.png?width=auto&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: auto;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-09ae296b742993885c9a8437a9126081"><img src="images/architektur_cb.png?width=auto&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">Phase</th>
<th style="text-align:left">Ergebnis</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">Lexer/Parser</td>
<td style="text-align:left">AST</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">Semantische Analyse, Def-Phase</td>
<td style="text-align:left">Symboltabelle (Definitionen), Verkn√ºpfung Scopes mit AST-Knoten</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">Semantische Analyse, Ref-Phase</td>
<td style="text-align:left">Pr√ºfung auf nicht definierte Referenzen</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">Interpreter</td>
<td style="text-align:left">Abarbeitung, Nutzung von AST und Symboltabelle</td>
</tr>
</tbody>
</table>
<p>Das Erzeugen der Symboltabelle wird h√§ufig in zwei Phasen aufgeteilt: Zun√§chst
werden die Definitionen abgearbeitet und in der zweiten Phase wird noch einmal
√ºber den AST iteriert und die Referenzen werden gepr√ºft. Dies hat den Vorteil,
dass man mit Vorw√§rtsreferenzen arbeiten kann ...</p>
<p>F√ºr die semantische Analyse kann man gut mit Listenern arbeiten, f√ºr den Interpreter
werden oft Visitors eingesetzt.</p>
<p>Die einfachste Form von Interpretern sind die &quot;syntaxgesteuerten Interpreter&quot;. Durch
den Einsatz von attributierten Grammatiken und eingebetteten Aktionen kann in einfachen
F√§llen der Programmcode bereits beim Parsen interpretiert werden, d.h. nach dem Parsen
steht das Ergebnis fest.</p>
<p>Normalerweise traversiert man in Interpretern aber den AST, etwa mit dem Listener-
oder Visitor-Pattern. Die in dieser Sitzung gezeigten einfachen Beispiele der
syntaxgesteuerten Interpreter werden erweitert auf die jeweilige Traversierung mit
dem Listener- bzw. Visitor-Pattern. F√ºr nicht so einfache F√§lle braucht man aber
zus√§tzlich noch Speicherstrukturen, die wir in
<a href="astdriven-part1.md">AST-basierte Interpreter: Basics</a>
und
<a href="astdriven-part2.md">AST-basierte Interpreter: Funktionen und Klassen</a>
betrachten.</p>
</div>
</div>




    
    
    
    





    
    
        
        
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-podcast"></i> Videos (YouTube)</div>
  <div class="box-content">

<ul> <li><a href='https://youtu.be/s5wvvoYsxe4' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>VL Syntaxgesteuerte Interpreter</a></li></ul></div>
</div>




    
    
    
    





    
    
        
        
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-podcast"></i> Videos (HSBI-Medienportal)</div>
  <div class="box-content">

<ul> <li><a href='https://www.hsbi.de/medienportal/m/0e4ffb9743823767da26cf83c54fa2c87293bb9974ccb5b62e9111cccf01954b96fd29a449fc96097f0b8c549d93c720aed4c3fe079795dbe6246081b7c20a8f' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>VL Syntaxgesteuerte Interpreter</a></li></ul></div>
</div>




    
    





    

    

    
    
        
        
        
        
    
        
        
        
        
    
        
        
        
        
    
    

    
<div class="box notices cstyle tip">
  <div class="box-label"><i class="fas fa-lightbulb"></i> Lernziele</div>
  <div class="box-content">

<ul> <li>(K3) Attribute und eingebettete Aktionen in Bison und ANTLR</li> <li>(K3) Traversierung von Parse-Trees und Implementierung von Aktionen mit Hilfe des Listener-Patterns</li> <li>(K3) Traversierung von Parse-Trees und Implementierung von Aktionen mit Hilfe des Visitor-Patterns</li></ul></div>
</div>




    <h2 id="√ºberblick-interpreter">√úberblick Interpreter</h2>
<p><a href="#R-image-42e0cd923b15ef32d4c26de25a002a30" class="lightbox-link"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/syntaxdriven/interpreter.png?width=60%25&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: 60%;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-42e0cd923b15ef32d4c26de25a002a30"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/syntaxdriven/interpreter.png?width=60%25&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
<p>Beim Interpreter durchl√§uft der Sourcecode nur das Frontend, also die Analyse.
Es wird kein Code erzeugt, stattdessen f√ºhrt der Interpreter die Anweisungen
im AST bzw. IC aus. Dazu muss der Interpreter mit den Eingabedaten beschickt
werden.</p>
<p>Es gibt verschiedene Varianten, beispielsweise:</p>
<ul>
<li>
<p>Syntaxgesteuerte Interpreter</p>
<ul>
<li>Einfachste Variante, wird direkt im Parser mit abgearbeitet</li>
<li>Keine Symboltabellen, d.h. auch keine Typpr√ºfung oder Vorw√§rtsdeklarationen o.√§.
(d.h. erlaubt nur vergleichsweise einfache Sprachen)</li>
<li>Beispiel: siehe n√§chste Folie</li>
</ul>
</li>
<li>
<p>AST-basierte Interpreter</p>
<ul>
<li>Nutzt den AST und Symboltabellen</li>
<li>Beispiel: siehe weiter unten</li>
</ul>
</li>
<li>
<p>Stack-basierte Interpreter</p>
<ul>
<li>Simuliert eine <em>Stack Machine</em>, d.h. h√§lt alle (tempor√§ren) Werte auf einem Stack</li>
<li>Arbeitet typischerweise auf bereits stark vereinfachtem Zwischencode (IR),
etwa Bytecode</li>
</ul>
</li>
<li>
<p>Register-basierte Interpreter</p>
<ul>
<li>Simuliert eine <em>Register Machine</em>, d.h. h√§lt alle (tempor√§ren) Werte in virtuellen
Prozessor-Registern</li>
<li>Arbeitet typischerweise auf bereits stark vereinfachtem Zwischencode (IR),
etwa Bytecode</li>
</ul>
</li>
</ul>
<p>Weiterhin kann man Interpreter danach unterscheiden, ob sie interaktiv sind oder nicht.
Python kann beispielsweise direkt komplette Dateien verarbeiten oder interaktiv Eingaben
abarbeiten. Letztlich kommen dabei aber die oben dargestellten Varianten zum Einsatz.</p>
<h2 id="syntaxgesteuerte-interpreter-attributierte-grammatiken">Syntaxgesteuerte Interpreter: Attributierte Grammatiken</h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>s     : expr                    {System.err.println($expr.v);} ;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>expr <span style="color:#66d9ef">returns</span> [int v]
</span></span><span style="display:flex;"><span>      : e1<span style="color:#f92672">=</span>expr <span style="color:#e6db74">&#39;*&#39;</span> e2<span style="color:#f92672">=</span>expr     {$v = $e1.v * $e2.v;}
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> e1<span style="color:#f92672">=</span>expr <span style="color:#e6db74">&#39;+&#39;</span> e2<span style="color:#f92672">=</span>expr     {$v = $e1.v + $e2.v;}
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#66d9ef">DIGIT</span>                   {$v = $DIGIT.int;}
</span></span><span style="display:flex;"><span>      ;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DIGIT : [0-9] ;</span></span></code></pre></div><p>Die einfachste Form des Interpreters wird direkt beim Parsen ausgef√ºhrt und kommt ohne AST aus.
Der Nachteil ist, dass der AST dabei nicht vorverarbeitet werden kann, insbesondere entfallen
semantische Pr√ºfungen weitgehend.</p>
<p>√úber <code>returns [int v]</code> f√ºgt man der Regel <code>expr</code> ein Attribut <code>v</code> (Integer) hinzu, welches
man im jeweiligen Kontext abfragen bzw. setzen kann (agiert als R√ºckgabewert der generierten
Methode). Auf diesen Wert kann in den Aktionen mit <code>$v</code> zugegriffen werden.</p>
<p>Da in den Alternativen der Regel <code>expr</code> jeweils zwei &quot;Aufrufe&quot; dieser Regel auftauchen, muss
man per &quot;<code>e1=expr</code>&quot; bzw. &quot;<code>e2=expr</code>&quot; eindeutige Namen f√ºr die &quot;Aufrufe&quot; vergeben, hier <code>e1</code>
und <code>e2</code>.</p>
<h2 id="eingebettete-aktionen-in-antlr-i">Eingebettete Aktionen in ANTLR I</h2>
<p>Erinnerung: ANTLR generiert einen LL-Parser, d.h. es wird zu jeder Regel eine entsprechende
Methode generiert.</p>
<p>Analog zum R√ºckgabewert der Regel (Methode) <code>expr()</code> kann auf die Eigenschaften der Token und
Sub-Regeln zugegriffen werden: <code>$name.eigenschaft</code>. Dabei gibt es bei Token Eigenschaften wie
<code>text</code> (gematchter Text bei Token), <code>type</code> (Typ eines Tokens), <code>int</code> (Integerwert eines Tokens,
entspricht <code>Integer.valueOf($Token.text)</code>). Parser-Regeln haben u.a. ein <code>text</code>-Attribut und
ein spezielles Kontext-Objekt (<code>ctx</code>).</p>
<p>Die allgemeine Form lautet:</p>
<pre><code>rulename[args] returns [retvals] locals [localvars] : ... ;
</code></pre>
<p>Dabei werden die in &quot;<code>[...]</code>&quot; genannten Parameter mit Komma getrennt (Achtung: Abh√§ngig von
Zielsprache!).</p>
<p>Beispiel:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>add[int x] <span style="color:#66d9ef">returns</span> [int r] : <span style="color:#e6db74">&#39;+=&#39;</span> <span style="color:#66d9ef">INT</span> {$r = $x + $INT.int;} ;</span></span></code></pre></div><h2 id="eingebettete-aktionen-in-antlr-ii">Eingebettete Aktionen in ANTLR II</h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>@members {
</span></span><span style="display:flex;"><span>    int count = 0;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>expr <span style="color:#66d9ef">returns</span> [int v]
</span></span><span style="display:flex;"><span>      @after {System.out.println(count);}
</span></span><span style="display:flex;"><span>      : e1<span style="color:#f92672">=</span>expr <span style="color:#e6db74">&#39;*&#39;</span> e2<span style="color:#f92672">=</span>expr     {$v = $e1.v * $e2.v; count++;}
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> e1<span style="color:#f92672">=</span>expr <span style="color:#e6db74">&#39;+&#39;</span> e2<span style="color:#f92672">=</span>expr     {$v = $e1.v + $e2.v; count++;}
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#66d9ef">DIGIT</span>                   {$v = $DIGIT.int;}
</span></span><span style="display:flex;"><span>      ;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DIGIT : [0-9] ;</span></span></code></pre></div><p>Mit <code>@members { ... }</code> k√∂nnen im generierten Parser weitere Attribute angelegt
werden, die in den Regeln normal genutzt werden k√∂nnen.</p>
<p>Die mit <code>@after</code> markierte Aktion wird am Ende der Regel <code>list</code> ausgef√ºhrt. Analog
existiert <code>@init</code>.</p>
<h2 id="antlr-traversierung-des-ast-und-auslesen-von-kontext-objekten">ANTLR: Traversierung des AST und Auslesen von Kontext-Objekten</h2>
<p>Mit dem obigen Beispiel, welches dem Einsatz einer L-attributierten SDD in ANTLR
entspricht, k√∂nnen einfache Aufgaben bereits beim Parsen erledigt werden.</p>
<p>F√ºr den etwas komplexeren Einsatz von attributierten Grammatiken kann man die von
ANTLR erzeugten Kontext-Objekte f√ºr die einzelnen AST-Knoten nutzen und √ºber den
AST mit dem Visitor- oder dem Listener-Pattern iterieren.</p>
<p>Die Techniken sollen im Folgenden kurz vorgestellt werden.</p>
<h3 id="antlr-kontext-objekte-f√ºr-parser-regeln">ANTLR: Kontext-Objekte f√ºr Parser-Regeln</h3>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>s    : expr         {List&lt;EContext&gt; x = $expr.ctx.e();} ;
</span></span><span style="display:flex;"><span>expr : e <span style="color:#e6db74">&#39;*&#39;</span> e ;</span></span></code></pre></div><p><a href="#R-image-c823a2c1dfca611aea728b1e313e21e8" class="lightbox-link"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/syntaxdriven/ParserRuleContext.png?width=auto&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: auto;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-c823a2c1dfca611aea728b1e313e21e8"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/syntaxdriven/ParserRuleContext.png?width=auto&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
<p>Jede Regel liefert ein passend zu dieser Regel generiertes Kontext-Objekt
zur√ºck. Dar√ºber kann man das/die Kontextobjekt(e) der Sub-Regeln abfragen.</p>
<p>Die Regel <code>s()</code> liefert entsprechend ein <code>SContext</code>-Objekt und die Regel
<code>expr()</code> liefert ein <code>ExprContext</code>-Objekt zur√ºck.</p>
<p>In der Aktion fragt man das Kontextobjekt √ºber <code>ctx</code> ab.</p>
<p>F√ºr einfache Regel-Aufrufe liefert die parameterlose Methode nur ein
einziges Kontextobjekt (statt einer Liste) zur√ºck.</p>
<p><strong>Anmerkung</strong>: ANTLR generiert nur dann Felder f√ºr die Regel-Elemente im
Kontextobjekt, wenn diese in irgendeiner Form referenziert werden. Dies
kann beispielsweise durch Benennung (Definition eines Labels, siehe n√§chste
Folie) oder durch Nutzung in einer Aktion (siehe obiges Beispiel) geschehen.</p>
<h3 id="antlr-benannte-regel-elemente-oder-alternativen">ANTLR: Benannte Regel-Elemente oder Alternativen</h3>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>stat  : <span style="color:#e6db74">&#39;return&#39;</span> value<span style="color:#f92672">=</span>e <span style="color:#e6db74">&#39;;&#39;</span>    <span style="color:#f92672">#</span> <span style="color:#66d9ef">Return</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> <span style="color:#e6db74">&#39;break&#39;</span> <span style="color:#e6db74">&#39;;&#39;</span>             <span style="color:#f92672">#</span> <span style="color:#66d9ef">Break</span>
</span></span><span style="display:flex;"><span>      ;</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StatContext</span> <span style="color:#66d9ef">extends</span> ParserRuleContext <span style="color:#f92672">{</span> <span style="color:#f92672">...</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReturnContext</span> <span style="color:#66d9ef">extends</span> StatContext <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> EContext value<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> EContext <span style="color:#a6e22e">e</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#f92672">...</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BreakContext</span> <span style="color:#66d9ef">extends</span> StatContext <span style="color:#f92672">{</span> <span style="color:#f92672">...</span> <span style="color:#f92672">}</span></span></span></code></pre></div><p>Mit <code>value=e</code> wird der Aufruf der Regel <code>e</code> mit dem Label <code>value</code> belegt,
d.h. man kann mit <code>$e.text</code> oder <code>$value.text</code> auf das <code>text</code>-Attribut von
<code>e</code> zugreifen. Falls es in einer Produktion mehrere Aufrufe einer anderen
Regel gibt, <strong>muss</strong> man f√ºr den Zugriff auf die Attribute eindeutige Label
vergeben.</p>
<p>Analog wird f√ºr die beiden Alternativen je ein eigener Kontext erzeugt.</p>
<h3 id="antlr-arbeiten-mit-dem-listener-pattern">ANTLR: Arbeiten mit dem Listener-Pattern</h3>
<p>ANTLR (generiert auf Wunsch) zur Grammatik passende Listener (Interface und
leere Basisimplementierung). Beim Traversieren mit dem Default-<code>ParseTreeWalker</code>
wird der Parse-Tree mit Tiefensuche abgelaufen und jeweils beim Eintritt in
bzw. beim Austritt aus einen/m Knoten der passende Listener mit dem passenden
Kontext-Objekt aufgerufen.</p>
<p>Damit kann man die Grammatik &quot;f√ºr sich&quot; halten, d.h. unabh√§ngig von einer
konkreten Zielsprache und die Aktionen √ºber die Listener (oder Visitors, s.u.)
ausf√ºhren.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>expr : e1<span style="color:#f92672">=</span>expr <span style="color:#e6db74">&#39;*&#39;</span> e2<span style="color:#f92672">=</span>expr      <span style="color:#f92672">#</span> <span style="color:#66d9ef">MULT</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">|</span> e1<span style="color:#f92672">=</span>expr <span style="color:#e6db74">&#39;+&#39;</span> e2<span style="color:#f92672">=</span>expr      <span style="color:#f92672">#</span> <span style="color:#66d9ef">ADD</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">|</span> <span style="color:#66d9ef">DIGIT</span>                    <span style="color:#f92672">#</span> <span style="color:#66d9ef">ZAHL</span>
</span></span><span style="display:flex;"><span>     ;</span></span></code></pre></div><p>ANTLR kann zu dieser Grammatik einen passenden Listener (Interface <code>calcListener</code>)
generieren. Weiterhin generiert ANTLR eine leere Basisimplementierung (Klasse
<code>calcBaseListener</code>):</p>
<p><a href="#R-image-d7dbabdaa99d32b8a5421f7a498d0234" class="lightbox-link"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/syntaxdriven/ParseTreeListener.png?width=auto&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: auto;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-d7dbabdaa99d32b8a5421f7a498d0234"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/syntaxdriven/ParseTreeListener.png?width=auto&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
<p>Von dieser Basisklasse leitet man einen eigenen Listener ab und implementiert
die Methoden, die man ben√∂tigt.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyListener</span> <span style="color:#66d9ef">extends</span> calcBaseListener <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Stack<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> stack <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Stack<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">exitMULT</span><span style="color:#f92672">(</span>calcParser<span style="color:#f92672">.</span><span style="color:#a6e22e">MULTContext</span> ctx<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> right <span style="color:#f92672">=</span> stack<span style="color:#f92672">.</span><span style="color:#a6e22e">pop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> left <span style="color:#f92672">=</span> stack<span style="color:#f92672">.</span><span style="color:#a6e22e">pop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        stack<span style="color:#f92672">.</span><span style="color:#a6e22e">push</span><span style="color:#f92672">(</span>left <span style="color:#f92672">*</span> right<span style="color:#f92672">);</span>   <span style="color:#75715e">// {$v = $e1.v * $e2.v;}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">exitADD</span><span style="color:#f92672">(</span>calcParser<span style="color:#f92672">.</span><span style="color:#a6e22e">ADDContext</span> ctx<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> right <span style="color:#f92672">=</span> stack<span style="color:#f92672">.</span><span style="color:#a6e22e">pop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> left <span style="color:#f92672">=</span> stack<span style="color:#f92672">.</span><span style="color:#a6e22e">pop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        stack<span style="color:#f92672">.</span><span style="color:#a6e22e">push</span><span style="color:#f92672">(</span>left <span style="color:#f92672">+</span> right<span style="color:#f92672">);</span>   <span style="color:#75715e">// {$v = $e1.v + $e2.v;}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">exitZAHL</span><span style="color:#f92672">(</span>calcParser<span style="color:#f92672">.</span><span style="color:#a6e22e">ZAHLContext</span> ctx<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stack<span style="color:#f92672">.</span><span style="color:#a6e22e">push</span><span style="color:#f92672">(</span>Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>ctx<span style="color:#f92672">.</span><span style="color:#a6e22e">DIGIT</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getText</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div><p>Anschlie√üend baut man das alles in eine Traversierung des Parse-Trees ein:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestMyListener</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyListener</span> <span style="color:#66d9ef">extends</span> calcBaseListener <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        calcLexer lexer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> calcLexer<span style="color:#f92672">(</span>CharStreams<span style="color:#f92672">.</span><span style="color:#a6e22e">fromStream</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">in</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        CommonTokenStream tokens <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CommonTokenStream<span style="color:#f92672">(</span>lexer<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        calcParser parser <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> calcParser<span style="color:#f92672">(</span>tokens<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ParseTree tree <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span><span style="color:#a6e22e">s</span><span style="color:#f92672">();</span>    <span style="color:#75715e">// Start-Regel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>tree<span style="color:#f92672">.</span><span style="color:#a6e22e">toStringTree</span><span style="color:#f92672">(</span>parser<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ParseTreeWalker walker <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ParseTreeWalker<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        MyListener eval <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MyListener<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        walker<span style="color:#f92672">.</span><span style="color:#a6e22e">walk</span><span style="color:#f92672">(</span>eval<span style="color:#f92672">,</span> tree<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>eval<span style="color:#f92672">.</span><span style="color:#a6e22e">stack</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pop</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div><div style="text-align: right;">
<span class="btn cstyle default">
  <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/lecture/interpretation/src/TestMyListener.java" target="_blank">
    Beispiel: TestMyListener.java und calc.g4
  </a>
</span></div>
<h3 id="antlr-arbeiten-mit-dem-visitor-pattern">ANTLR: Arbeiten mit dem Visitor-Pattern</h3>
<p>ANTLR (generiert ebenfalls auf Wunsch) zur Grammatik passende Visitoren
(Interface und leere Basisimplementierung). Hier muss man allerdings selbst
f√ºr eine geeignete Traversierung des Parse-Trees sorgen. Daf√ºr hat man mehr
Freiheiten im Vergleich zum Listener-Pattern, insbesondere im Hinblick auf
R√ºckgabewerte.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>expr : e1<span style="color:#f92672">=</span>expr <span style="color:#e6db74">&#39;*&#39;</span> e2<span style="color:#f92672">=</span>expr      <span style="color:#f92672">#</span> <span style="color:#66d9ef">MULT</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">|</span> e1<span style="color:#f92672">=</span>expr <span style="color:#e6db74">&#39;+&#39;</span> e2<span style="color:#f92672">=</span>expr      <span style="color:#f92672">#</span> <span style="color:#66d9ef">ADD</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">|</span> <span style="color:#66d9ef">DIGIT</span>                    <span style="color:#f92672">#</span> <span style="color:#66d9ef">ZAHL</span>
</span></span><span style="display:flex;"><span>     ;</span></span></code></pre></div><p>ANTLR kann zu dieser Grammatik einen passenden Visitor (Interface <code>calcVisitor&lt;T&gt;</code>)
generieren. Weiterhin generiert ANTLR eine leere Basisimplementierung (Klasse
<code>calcBaseVisitor&lt;T&gt;</code>):</p>
<p><a href="#R-image-e77f81222e578fd6812c8843de1c2743" class="lightbox-link"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/syntaxdriven/ParseTreeVisitor.png?width=auto&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: auto;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e77f81222e578fd6812c8843de1c2743"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/syntaxdriven/ParseTreeVisitor.png?width=auto&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
<p>Von dieser Basisklasse leitet man einen eigenen Visitor ab und √ºberschreibt
die Methoden, die man ben√∂tigt. Wichtig ist, dass man selbst f√ºr das &quot;Besuchen&quot;
der Kindknoten sorgen muss (rekursiver Aufruf der geerbten Methode <code>visit()</code>).</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyVisitor</span> <span style="color:#66d9ef">extends</span> calcBaseVisitor<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Integer <span style="color:#a6e22e">visitMULT</span><span style="color:#f92672">(</span>calcParser<span style="color:#f92672">.</span><span style="color:#a6e22e">MULTContext</span> ctx<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> visit<span style="color:#f92672">(</span>ctx<span style="color:#f92672">.</span><span style="color:#a6e22e">e1</span><span style="color:#f92672">)</span> <span style="color:#f92672">*</span> visit<span style="color:#f92672">(</span>ctx<span style="color:#f92672">.</span><span style="color:#a6e22e">e2</span><span style="color:#f92672">);</span>   <span style="color:#75715e">// {$v = $e1.v * $e2.v;}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Integer <span style="color:#a6e22e">visitADD</span><span style="color:#f92672">(</span>calcParser<span style="color:#f92672">.</span><span style="color:#a6e22e">ADDContext</span> ctx<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> visit<span style="color:#f92672">(</span>ctx<span style="color:#f92672">.</span><span style="color:#a6e22e">e1</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> visit<span style="color:#f92672">(</span>ctx<span style="color:#f92672">.</span><span style="color:#a6e22e">e2</span><span style="color:#f92672">);</span>   <span style="color:#75715e">// {$v = $e1.v + $e2.v;}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Integer <span style="color:#a6e22e">visitZAHL</span><span style="color:#f92672">(</span>calcParser<span style="color:#f92672">.</span><span style="color:#a6e22e">ZAHLContext</span> ctx<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>ctx<span style="color:#f92672">.</span><span style="color:#a6e22e">DIGIT</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getText</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div><p>Anschlie√üend baut man das alles in eine manuelle Traversierung des Parse-Trees ein:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestMyVisitor</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyVisitor</span> <span style="color:#66d9ef">extends</span> calcBaseVisitor<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        calcLexer lexer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> calcLexer<span style="color:#f92672">(</span>CharStreams<span style="color:#f92672">.</span><span style="color:#a6e22e">fromStream</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">in</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        CommonTokenStream tokens <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CommonTokenStream<span style="color:#f92672">(</span>lexer<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        calcParser parser <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> calcParser<span style="color:#f92672">(</span>tokens<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ParseTree tree <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span><span style="color:#a6e22e">s</span><span style="color:#f92672">();</span>    <span style="color:#75715e">// Start-Regel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>tree<span style="color:#f92672">.</span><span style="color:#a6e22e">toStringTree</span><span style="color:#f92672">(</span>parser<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        MyVisitor eval <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MyVisitor<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>eval<span style="color:#f92672">.</span><span style="color:#a6e22e">visit</span><span style="color:#f92672">(</span>tree<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div><div style="text-align: right;">
<span class="btn cstyle default">
  <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/lecture/interpretation/src/TestMyVisitor.java" target="_blank">
    Beispiel: TestMyVisitor.java und calc.g4
  </a>
</span></div>
<h2 id="wrap-up">Wrap-Up</h2>
<ul>
<li>
<p>Interpreter simulieren die Programmausf√ºhrung</p>
</li>
<li>
<p>Syntaxgesteuerter Interpreter (attributierte Grammatiken)</p>
</li>
<li>
<p>Beispiel ANTLR: Eingebettete Aktionen, Kontextobjekte, Visitors/Listeners (AST-Traversierung)</p>
</li>
</ul>


    



    



    





    




    
    
        
        

        
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
            
            
                
            
            
        
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
            
            
                
            
            
        
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
            
            
                
            
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-book-reader"></i> Quellen</div>
  <div class="box-content">

<ul> <li id='id_Nystrom2021'>[Nystrom2021] <a href='https://github.com/munificent/craftinginterpreters' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'><strong>Crafting Interpreters</strong></a><br>Nystrom, R., Genever Benning, 2021. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-0-9905829-3-9' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-0-9905829-3-9</a>.<br><em>Kapitel: A Tree-Walk Interpreter</em></li> <li id='id_Parr2010'>[Parr2010] <strong>Language Implementation Patterns</strong><br>Parr, T., Pragmatic Bookshelf, 2010. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-1-9343-5645-6' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-1-9343-5645-6</a>.<br><em>Kapitel 8 und 9</em></li> <li id='id_Parr2014'>[Parr2014] <strong>The Definitive ANTLR 4 Reference</strong><br>Parr, T., Pragmatic Bookshelf, 2014. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-1-9343-5699-9' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-1-9343-5699-9</a>.<br><em>Kapitel 6.4 und 8.4</em></li></ul></div>
</div>






<footer class="footline"><div style="color: darkgray; font-size: small;">
<p style="margin: 4rem;">
<!-- https://creativecommons.org/choose/ -->
<a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0;margin:0;display:inline;" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
Unless otherwise noted, <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master">this work</a> by <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/bcg7" property="cc:attributionName" rel="cc:attributionURL">BC George</a>, <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/cagix" property="cc:attributionName" rel="cc:attributionURL">Carsten Gips</a>, and <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/graphs/contributors">contributors</a> is licensed under <a rel="license" href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/LICENSE.md">CC BY-SA 4.0</a>.
See the <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/CREDITS.md">credits</a> for a detailed list of contributing projects.

</p>
</div>

</footer>
</article>

<article class="default">
<h1>AST-basierte Interpreter: Basics</h1>



    



    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-graduation-cap"></i> TL;DR</div>
  <div class="box-content">

<p>Ein AST-basierter Interpreter besteht oft aus einem &quot;Visitor-Dispatcher&quot;: Man traversiert
mit einer <code>eval()</code>-Funktion den AST und ruft je nach Knotentyp die passende Funktion auf.
Dabei werden bei Ausdr√ºcken (<em>Expressions</em>) Werte berechnet und zur√ºckgegeben, d.h. hier
hat man einen R√ºckgabewert und ein entsprechendes <code>return</code> im <code>switch</code>/<code>case</code>, w√§hrend man
bei Anweisungen (<em>Statements</em>) keinen R√ºckgabewert hat.</p>
<p>Der Wert von Literalen ergibt sich direkt durch die √úbersetzung des jeweiligen Werts in den
passenden Typ der Implementierungssprache. Bei einfachen Ausdr√ºcken kann man auf das in
<a href="syntaxdriven.md">Syntaxgesteuerte Interpreter</a>
demonstrierte Vorgehen zur√ºckgreifen: Man interpretiert zun√§chst die Teilausdr√ºcke durch den
Aufruf von <code>eval()</code> f√ºr die jeweiligen AST-Kindknoten und berechnet daraus das gew√ºnschte
Ergebnis.</p>
<p>F√ºr Bl√∂cke und Variablen muss man analog zum Aufbau von Symboltabellen wieder Scopes
ber√ºcksichtigen, d.h. man ben√∂tigt Strukturen √§hnlich zu den Symboltabellen (hier &quot;Umgebung&quot;
(<em>Environment</em>) genannt). Es gibt eine globale Umgebung, und mit dem Betreten eines neuen
Blocks wird eine neue Umgebung aufgemacht, deren Eltern-Umgebung die bisherige Umgebung ist.</p>
<p>Zu jedem Namen kann man in einer Umgebung einen Wert definieren bzw. abrufen. Dabei muss man
je nach Semantik der zu interpretierenden Sprache unterscheiden zwischen der &quot;Definition&quot; und
der &quot;Zuweisung&quot; einer Variablen: Die Definition erfolgt i.d.R. in der aktuellen Umgebung, bei
der Zuweisung sucht man ausgehend von der aktuellen Umgebung bis hoch zur globalen Umgebung
nach dem ersten Vorkommen der Variablen und setzt den Wert in der gefundenen Umgebung. Bei
Sprachen, die Variablen beim ersten Zugriff definieren, muss man dieses Verhalten entsprechend
anpassen.</p>
</div>
</div>




    
    
    
    





    
    
        
        
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-podcast"></i> Videos (YouTube)</div>
  <div class="box-content">

<ul> <li><a href='https://youtu.be/lupQ0f3Tp7A' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>VL AST-basierte Interpreter (Basics)</a></li></ul></div>
</div>




    
    
    
    





    
    
        
        
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-podcast"></i> Videos (HSBI-Medienportal)</div>
  <div class="box-content">

<ul> <li><a href='https://www.hsbi.de/medienportal/m/18b6c77bbd5ecc90730df421e3ed175ae4670f56dd8b1a7bdd517066a2b1e7669e074c8f473e88f7f6073f2bd25092ceca16eee95953412a7f9fa5597a7acd9a' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>VL AST-basierte Interpreter (Basics)</a></li></ul></div>
</div>




    
    





    

    

    
    
        
        
        
        
    
        
        
        
        
    
        
        
        
        
    
    

    
<div class="box notices cstyle tip">
  <div class="box-label"><i class="fas fa-lightbulb"></i> Lernziele</div>
  <div class="box-content">

<ul> <li>(K3) Traversierung von Parse-Trees und Implementierung von Aktionen mit Hilfe des Visitor-Patterns</li> <li>(K3) Interpreter m√ºssen Namen und Werte speichern: Environment-Strukturen analog zu den Symboltabellen</li> <li>(K3) Code-Ausf√ºhrung im Interpreter durch eine Read-Eval-Schleife: Implementierung mit einem Visitor</li></ul></div>
</div>




    <h2 id="aufgaben-im-interpreter">Aufgaben im Interpreter</h2>
<p>Im Allgemeinen reichen einfache syntaxgesteuerte Interpreter nicht aus. Normalerweise simuliert
ein Interpreter die Ausf√ºhrung eines Programms durch den Computer. D.h. der Interpreter muss
√ºber die entsprechenden Eigenschaften verf√ºgen: Prozessor, Code-Speicher, Datenspeicher, Stack ...</p>
<div class='columns'>
<div class='column'>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">f</span>(<span style="color:#66d9ef">int</span> x) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> y <span style="color:#f92672">=</span> <span style="color:#ae81ff">9</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y<span style="color:#f92672">+</span>x;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> <span style="color:#a6e22e">f</span>(x);</span></span></code></pre></div></div>
<div class='column'>
<ul>
<li>
<p>Aufbauen des AST ... =&gt; Lexer+Parser</p>
</li>
<li>
<p>Aufl√∂sen von Symbolen/Namen ... =&gt; Symboltabellen, Resolving</p>
</li>
<li>
<p>Type-Checking und -Inference ... =&gt; Semantische Analyse (auf Symboltabellen)</p>
</li>
<li>
<p>Speichern von Daten: Name+Wert vs. Adresse+Wert (Erinnerung: Data-Segment und Stack im virtuellen Speicher)</p>
</li>
<li>
<p>Ausf√ºhren von Anweisungen Text-Segment im virtuellen Speicher; hier √ºber den AST</p>
</li>
<li>
<p>Aufruf von Funktionen und Methoden Kontextwechsel n√∂tig: Was ist von wo aus sichtbar?</p>
</li>
</ul>
</div>
</div>
<h2 id="ast-basierte-interpreter-visitor-dispatcher">AST-basierte Interpreter: Visitor-Dispatcher</h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">eval</span>(self, AST t):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>   t<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> Parser<span style="color:#f92672">.</span>BLOCK  : block(t)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> t<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> Parser<span style="color:#f92672">.</span>ASSIGN : assign(t)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> t<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> Parser<span style="color:#f92672">.</span>RETURN : ret(t)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> t<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> Parser<span style="color:#f92672">.</span>IF     : ifstat(t)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> t<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> Parser<span style="color:#f92672">.</span>CALL   : <span style="color:#66d9ef">return</span> call(t)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> t<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> Parser<span style="color:#f92672">.</span>ADD    : <span style="color:#66d9ef">return</span> add(t)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> t<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> Parser<span style="color:#f92672">.</span>MUL    : <span style="color:#66d9ef">return</span> mul(t)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> t<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> Parser<span style="color:#f92672">.</span>INT    : <span style="color:#66d9ef">return</span> Integer<span style="color:#f92672">.</span>parseInt(t<span style="color:#f92672">.</span>getText())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> t<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> Parser<span style="color:#f92672">.</span>ID     : <span style="color:#66d9ef">return</span> load(t)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> : <span style="color:#f92672">...</span>  <span style="color:#75715e"># catch unhandled node types</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>;</span></span></code></pre></div><p>Nach dem Aufbau des AST durch Scanner und Parser und der semantischen Analyse
anhand der Symboltabellen m√ºssen die Ausdr√ºcke (<em>expressions</em>) und Anweisungen
(<em>statements</em>) durch den Interpreter ausgewertet werden. Eine M√∂glichkeit dazu
ist das Traversieren des AST mit dem Visitor-Pattern. Basierend auf dem Typ
des aktuell betrachteten AST-Knotens wird entschieden, wie damit umgegangen
werden soll. Dies erinnert an den Aufbau der Symboltabellen ...</p>
<p>Die <code>eval()</code>-Methode bildet das Kernst√ºck des (AST-traversierenden) Interpreters.
Hier wird passend zum aktuellen AST-Knoten die passende Methode des Interpreters
aufgerufen.</p>
<p><strong>Hinweis</strong>: Im obigen Beispiel wird nicht zwischen der Auswertung von
Ausdr√ºcken und Anweisungen unterschieden, es wird die selbe Methode <code>eval()</code>
genutzt. Allerdings liefern Ausdr√ºcke einen Wert zur√ºck (erkennbar am <code>return</code>
im jeweiligen <code>switch/case</code>-Zweig), w√§hrend Anweisungen keinen Wert liefern.</p>
<p>In den folgenden Beispielen wird davon ausgegangen, dass ein komplettes
Programm eingelesen, geparst, vorverarbeitet und dann interpretiert wird.</p>
<p>F√ºr einen interaktiven Interpreter w√ºrde man in einer Schleife die Eingaben
lesen, parsen und vorverarbeiten und dann interpretieren. Dabei w√ºrde jeweils
der AST und die Symboltabelle <em>erg√§nzt</em>, damit die neuen Eingaben auf fr√ºhere
verarbeitete Eingaben zur√ºckgreifen k√∂nnen. Durch die Form der Schleife
&quot;Einlesen -- Verarbeiten -- Auswerten&quot; hat sich auch der Name &quot;<em>Read-Eval-Loop</em>&quot;
bzw. &quot;<em>Read-Eval-Print-Loop</em>&quot; (<strong>REPL</strong>) eingeb√ºrgert.</p>
<h2 id="auswertung-von-literalen-und-ausdr√ºcken">Auswertung von Literalen und Ausdr√ºcken</h2>
<ul>
<li>
<p>Typen mappen: Zielsprache =&gt; Implementierungssprache</p>
<p>Die in der Zielsprache verwendeten (primitiven) Typen m√ºssen
auf passende Typen der Sprache, in der der Interpreter selbst
implementiert ist, abgebildet werden.</p>
<p>Beispielsweise k√∂nnte man den Typ <code>nil</code> der Zielsprache auf den
Typ <code>null</code> des in Java implementierten Interpreters abbilden, oder
den Typ <code>number</code> der Zielsprache auf den Typ <code>Double</code> in Java
mappen.</p>
</li>
<li>
<p>Literale auswerten:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>INT: [0-9]<span style="color:#f92672">+</span> ;</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">elif</span> t<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> Parser<span style="color:#f92672">.</span>INT : <span style="color:#66d9ef">return</span> Integer<span style="color:#f92672">.</span>parseInt(t<span style="color:#f92672">.</span>getText())</span></span></code></pre></div><p>Das ist der einfachste Teil ... Die primitiven Typen der
Zielsprache, f√ºr die es meist ein eigenes Token gibt, m√ºssen
als Datentyp der Interpreter-Programmiersprache ausgewertet
werden.</p>
</li>
<li>
<p>Ausdr√ºcke auswerten:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>add: e1<span style="color:#f92672">=</span>expr <span style="color:#e6db74">&#34;+&#34;</span> e2<span style="color:#f92672">=</span>expr ;</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(self, AST t):
</span></span><span style="display:flex;"><span>    lhs <span style="color:#f92672">=</span> eval(t<span style="color:#f92672">.</span>e1())
</span></span><span style="display:flex;"><span>    rhs <span style="color:#f92672">=</span> eval(t<span style="color:#f92672">.</span>e2())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (double)lhs <span style="color:#f92672">+</span> (double)rhs  <span style="color:#75715e"># Semantik!</span></span></span></code></pre></div><p>Die meisten m√∂glichen Fehlerzust√§nde sind bereits durch den Parser
und bei der semantischen Analyse abgefangen worden. Falls zur Laufzeit
die Auswertung der beiden Summanden keine Zahl ergibt, w√ºrde eine
Java-Exception geworfen, die man an geeigneter Stelle fangen und
behandeln muss. Der Interpreter soll sich ja nicht mit einem Stack-Trace
verabschieden, sondern soll eine Fehlermeldung pr√§sentieren und danach
normal weiter machen ...</p>
</li>
</ul>
<h2 id="kontrollstrukturen">Kontrollstrukturen</h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>ifstat: <span style="color:#e6db74">&#39;if&#39;</span> expr <span style="color:#e6db74">&#39;then&#39;</span> s1<span style="color:#f92672">=</span>stat <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;else&#39;</span> s2<span style="color:#f92672">=</span>stat<span style="color:#f92672">)?</span> ;</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ifstat</span>(self, AST t):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> eval(t<span style="color:#f92672">.</span>expr()): eval(t<span style="color:#f92672">.</span>s1())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> t<span style="color:#f92672">.</span>s2(): eval(t<span style="color:#f92672">.</span>s2())</span></span></code></pre></div><p>Analog k√∂nnen die anderen bekannten Kontrollstrukturen umgesetzt werden,
etwa <code>switch/case</code>, <code>while</code> oder <code>for</code>.</p>
<p>Dabei k√∂nnen erste Optimierungen vorgenommen werden: Beispielsweise k√∂nnten
<code>for</code>-Schleifen im Interpreter in <code>while</code>-Schleifen transformiert werden,
wodurch im Interpreter nur ein Schleifenkonstrukt implementiert werden
m√ºsste.</p>
<h2 id="zust√§nde-auswerten-von-anweisungen">Zust√§nde: Auswerten von Anweisungen</h2>
<div class='columns'>
<div class='column'>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> y;
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> x;
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    { <span style="color:#66d9ef">int</span> y <span style="color:#f92672">=</span> x; }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
<div class='column'>
<p><a href="#R-image-9c7d3e160ea017a8027655dfd61746fa" class="lightbox-link"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/astdriven-part1/nested_envs.png?width=auto&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: auto;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-9c7d3e160ea017a8027655dfd61746fa"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/astdriven-part1/nested_envs.png?width=auto&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
</div>
</div>
<p>Das erinnert nicht nur zuf√§llig an den Aufbau der Symboltabellen :-)</p>
<p>Und so lange es nur um Variablen ginge, k√∂nnte man die Symboltabellen f√ºr das
Speichern der Werte nutzen. Allerdings m√ºssen wir noch Funktionen und Strukturen
bzw. Klassen realisieren, und sp√§testens dann kann man die Symboltabelle nicht
mehr zum Speichern von Werten einsetzen. Also lohnt es sich, direkt neue
Strukturen f√ºr das Halten von Variablen und Werten aufzubauen.</p>
<h2 id="detail-felder-im-interpreter">Detail: Felder im Interpreter</h2>
<p>Eine m√∂gliche Implementierung f√ºr einen Interpreter basierend auf einem
ANTLR-Visitor ist nachfolgend gezeigt.</p>
<p><strong>Hinweis</strong>: Bei der Ableitung des <code>BaseVisitor&lt;T&gt;</code> muss der Typ <code>T</code>
festgelegt werden. Dieser fungiert als R√ºckgabetyp f√ºr die Visitor-Methoden.
Entsprechend k√∂nnen alle Methoden nur einen gemeinsamen (Ober-) Typ zur√ºckliefern,
weshalb man sich an der Stelle oft mit <code>Object</code> behilft und dann manuell
den konkreten Typ abfragen und korrekt casten muss.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Interpreter</span>(BaseVisitor<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span>):
</span></span><span style="display:flex;"><span>    __init__(self, AST t):
</span></span><span style="display:flex;"><span>        BaseVisitor<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;.</span>__init__(self)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>root <span style="color:#f92672">=</span> t
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>env <span style="color:#f92672">=</span> Environment()</span></span></code></pre></div><p><span class='origin'>Quelle: Eigener Code basierend auf einer Idee nach <a href="https://github.com/munificent/craftinginterpreters/blob/master/java/com/craftinginterpreters/lox/Interpreter.java#L21" target="_blank">Interpreter.java</a> by <a href="https://github.com/munificent" target="_blank">Bob Nystrom</a> on Github.com (<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">MIT</a>)</span></p>
<h2 id="ausf√ºhren-einer-variablendeklaration">Ausf√ºhren einer Variablendeklaration</h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>varDecl: <span style="color:#e6db74">&#34;var&#34;</span> <span style="color:#66d9ef">ID</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;=&#34;</span> expr<span style="color:#f92672">)?</span> <span style="color:#e6db74">&#34;;&#34;</span> ;</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">varDecl</span>(self, AST t):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># deklarierte Variable (String)</span>
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> t<span style="color:#f92672">.</span>ID()<span style="color:#f92672">.</span>getText()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    value <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>;  <span style="color:#75715e"># TODO: Typ der Variablen beachten (Defaultwert)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> t<span style="color:#f92672">.</span>expr(): value <span style="color:#f92672">=</span> eval(t<span style="color:#f92672">.</span>expr())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>define(name, value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span></span></span></code></pre></div><p>Wenn wir bei der Traversierung des AST mit <code>eval()</code> bei einer Variablendeklaration
vorbeikommen, also etwa <code>int x;</code> oder <code>int x = wuppie + fluppie;</code>, dann wird im
<strong>aktuellen</strong> Environment der String &quot;x&quot; sowie der Wert (im zweiten Fall) eingetragen.</p>
<h2 id="ausf√ºhren-einer-zuweisung">Ausf√ºhren einer Zuweisung</h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>assign: <span style="color:#66d9ef">ID</span> <span style="color:#e6db74">&#34;=&#34;</span> expr;</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">assign</span>(self, AST t):
</span></span><span style="display:flex;"><span>    lhs <span style="color:#f92672">=</span> t<span style="color:#f92672">.</span>ID()<span style="color:#f92672">.</span>getText()
</span></span><span style="display:flex;"><span>    value <span style="color:#f92672">=</span> eval(t<span style="color:#f92672">.</span>expr())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>assign(lhs, value)  <span style="color:#75715e"># Semantik!</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Environment</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">assign</span>(self, String n, Object v):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>values[n]: self<span style="color:#f92672">.</span>values[n] <span style="color:#f92672">=</span> v
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> self<span style="color:#f92672">.</span>enclosing: self<span style="color:#f92672">.</span>enclosing<span style="color:#f92672">.</span>assign(n, v)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>: <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(n, <span style="color:#e6db74">&#34;undefined variable&#34;</span>)</span></span></code></pre></div><p><span class='origin'>Quelle: Eigener Code basierend auf einer Idee nach <a href="https://github.com/munificent/craftinginterpreters/blob/master/java/com/craftinginterpreters/lox/Environment.java#L38" target="_blank">Environment.java</a> by <a href="https://github.com/munificent" target="_blank">Bob Nystrom</a> on Github.com (<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">MIT</a>)</span></p>
<p>Wenn wir bei der Traversierung des AST mit <code>eval()</code> bei einer Zuweisung
vorbeikommen, also etwa <code>x = 7;</code> oder <code>x = wuppie + fluppie;</code>, dann wird
zun√§chst im aktuellen Environment die rechte Seite der Zuweisung ausgewertet
(Aufruf von <code>eval()</code>). Anschlie√üend wird der Wert f√ºr die Variable im
Environment eingetragen: Entweder sie wurde im aktuellen Environment fr√ºher
bereits definiert, dann wird der neue Wert hier eingetragen. Ansonsten wird
entlang der Verschachtelungshierarchie gesucht und entsprechend eingetragen.
Falls die Variable nicht gefunden werden kann, wird eine Exception ausgel√∂st.</p>
<p>An dieser Stelle kann man √ºber die Methode <code>assign</code> in der Klasse <code>Environment</code>
daf√ºr sorgen, dass nur bereits deklarierte Variablen zugewiesen werden d√ºrfen.
Wenn man stattdessen wie etwa in Python das implizite Erzeugen neuer
Variablen erlaubten m√∂chte, w√ºrde man statt <code>Environment#assign</code> einfach
<code>Environment#define</code> nutzen ...</p>
<p><em>Anmerkung</em>: Der gezeigte Code funktioniert nur f√ºr normale Variablen, nicht
f√ºr Zugriffe auf Attribute einer Struct oder Klasse!</p>
<h2 id="bl√∂cke-umgang-mit-verschachtelten-environments">Bl√∂cke: Umgang mit verschachtelten Environments</h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>block:  <span style="color:#e6db74">&#39;{&#39;</span> stat<span style="color:#f92672">*</span> <span style="color:#e6db74">&#39;}&#39;</span> ;</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">block</span>(self, AST t):
</span></span><span style="display:flex;"><span>    prev <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>env
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>env <span style="color:#f92672">=</span> Environment(self<span style="color:#f92672">.</span>env)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> t<span style="color:#f92672">.</span>stat(): eval(s)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">finally</span>: self<span style="color:#f92672">.</span>env <span style="color:#f92672">=</span> prev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>;</span></span></code></pre></div><p><span class='origin'>Quelle: Eigener Code basierend auf einer Idee nach <a href="https://github.com/munificent/craftinginterpreters/blob/master/java/com/craftinginterpreters/lox/Interpreter.java#L92" target="_blank">Interpreter.java</a> by <a href="https://github.com/munificent" target="_blank">Bob Nystrom</a> on Github.com (<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">MIT</a>)</span></p>
<p>Beim Interpretieren von Bl√∂cken muss man einfach nur eine weitere
Verschachtelungsebene f√ºr die Environments anlegen und darin dann
die Anweisungen eines Blockes auswerten ...</p>
<p><strong>Wichtig</strong>: Egal, was beim Auswerten der Anweisungen in einem Block
passiert: Es muss am Ende die urspr√ºngliche Umgebung wieder hergestellt
werden (<code>finally</code>-Block).</p>
<h2 id="wrap-up">Wrap-Up</h2>
<ul>
<li>
<p>Interpreter simulieren die Programmausf√ºhrung</p>
<ul>
<li>Namen und Symbole aufl√∂sen</li>
<li>Speicherbereiche simulieren</li>
<li>Code ausf√ºhren: Read-Eval-Loop</li>
</ul>
</li>
<li>
<p>Traversierung des AST: <code>eval(AST t)</code> als Visitor-Dispatcher</p>
</li>
<li>
<p>Scopes mit <code>Environment</code> (analog zu Symboltabellen)</p>
</li>
<li>
<p>Interpretation von Bl√∂cken und Variablen (Deklaration, Zuweisung)</p>
</li>
</ul>


    



    



    





    




    
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
            
            
                
            
            
        
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
                    
                
            
            
                
            
            
        
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
            
            
                
            
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-book-reader"></i> Quellen</div>
  <div class="box-content">

<ul> <li id='id_Grune2012'>[Grune2012] <strong>Modern Compiler Design</strong><br>Grune, D. und van, Reeuwijk, K. und Bal, H. E. und Jacobs, C. J. H. und Langendoen, K., Springer, 2012. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-1-4614-4698-9' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-1-4614-4698-9</a>.<br><em>Kapitel 6</em></li> <li id='id_Mogensen2017'>[Mogensen2017] <strong>Introduction to Compiler Design</strong><br>Mogensen, T., Springer, 2017. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-3-319-66966-3' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-3-319-66966-3</a>. DOI <a href='https://doi.org/10.1007/978-3-319-66966-3' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>10.1007/978-3-319-66966-3</a>.<br><em>Kapitel 4</em></li> <li id='id_Nystrom2021'>[Nystrom2021] <a href='https://github.com/munificent/craftinginterpreters' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'><strong>Crafting Interpreters</strong></a><br>Nystrom, R., Genever Benning, 2021. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-0-9905829-3-9' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-0-9905829-3-9</a>.<br><em>Kapitel Kapitel: A Tree-Walk Interpreter, insb. 8. Statements and State</em></li></ul></div>
</div>






<footer class="footline"><div style="color: darkgray; font-size: small;">
<p style="margin: 4rem;">
<!-- https://creativecommons.org/choose/ -->
<a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0;margin:0;display:inline;" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
Unless otherwise noted, <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master">this work</a> by <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/bcg7" property="cc:attributionName" rel="cc:attributionURL">BC George</a>, <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/cagix" property="cc:attributionName" rel="cc:attributionURL">Carsten Gips</a>, and <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/graphs/contributors">contributors</a> is licensed under <a rel="license" href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/LICENSE.md">CC BY-SA 4.0</a>.
See the <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/CREDITS.md">credits</a> for a detailed list of contributing projects.

</p>
</div>

</footer>
</article>

<article class="default">
<h1>AST-basierte Interpreter: Funktionen und Klassen</h1>



    



    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-graduation-cap"></i> TL;DR</div>
  <div class="box-content">

<p>√úblicherweise k√∂nnen Funktionen auf die Umgebung zur√ºckgreifen, in der die Definition der
Funktion erfolgt ist (<a href="https://en.wikipedia.org/wiki/Closure_%28computer_programming%29" target="_blank">&quot;<strong>Closure</strong>&quot;</a>).
Deshalb wird beim Interpretieren einer Funktionsdefinition der jeweilige AST-Knoten (mit
dem Block des Funktionsk√∂rpers) und die aktuelle Umgebung in einer Struktur zusammengefasst.
Zus√§tzlich muss in der aktuellen Umgebung der Name der Funktion zusammen mit der eben erzeugten
Struktur (&quot;Funktionsobjekt&quot;) als Wert definiert werden.</p>
<p>Beim Funktionsaufruf l√∂st man den Funktionsnamen in der aktuellen Umgebung auf und erh√§lt
das Funktionsobjekt mit dem AST der Funktion und der Closure. Die Funktionsparameter werden
ebenfalls in der aktuellen Umgebung aufgel√∂st (Aufruf von <code>eval()</code> f√ºr die AST-Kindknoten
des Funktionsaufrufs). Zur Interpretation der Funktion legt man sich eine neue Umgebung an,
deren Eltern-Umgebung die Closure der Funktion ist, definiert die Funktionsparameter (Name
und eben ermittelter Wert) in dieser neuen Umgebung und interpretiert dann den AST-Kindknoten
des Funktionsblocks in dieser neuen Umgebung. F√ºr den R√ºckgabewert muss man ein wenig tricksen:
Ein Block hat normalerweise keinen Wert. Eine M√∂glichkeit w√§re, bei der Interpretation eines
<code>return</code>-Statements eine Exception mit dem Wert des Ausdruck hinter dem &quot;<code>return</code>&quot; zu werfen
und im <code>eval()</code> des Funktionsblock zu fangen.</p>
<p>F√ºr Klassen kann man analog verfahren. Methoden sind zun√§chst einfach Funktionen, die in einem
Klassenobjekt gesammelt werden. Das Erzeugen einer Instanz einer Klasse ist die Interpretation
eines &quot;Aufrufs&quot; der Klasse (analog zum Aufruf einer Funktion): Dabei wird ein spezielles
Instanzobjekt erzeugt, welches auf die Klasse verweist und welches die Werte der Attribute h√§lt.
Beim Aufruf von Methoden auf einem Instanzobjekt wird der Name der Funktion √ºber das Klassenobjekt
aufgel√∂st, eine neue Umgebung erzeugt mit der Closure der Funktion als Eltern-Umgebung und das
Instanzobjekt wird in dieser Umgebung definiert als &quot;<code>this</code>&quot; oder &quot;<code>self</code>&quot;. Anschlie√üend wird
ein neues Funktionsobjekt mit der eben erzeugten Umgebung und dem Funktions-AST erzeugt und
zur√ºckgeliefert. Dieses neue Funktionsobjekt wird dann wie eine normale Funktion aufgerufen
(interpretiert, s.o.). Der Zugriff in der Methode auf die Attribute der Klasse erfolgt dann
√ºber <code>this</code> bzw. <code>self</code>, welche in der Closure der Funktion nun definiert sind und auf das
Instanzobjekt mit den Attributen verweisen.</p>
</div>
</div>




    
    
    
    





    
    
        
        
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-podcast"></i> Videos (YouTube)</div>
  <div class="box-content">

<ul> <li><a href='https://youtu.be/LTqk7ifB-V0' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>VL AST-basierte Interpreter (Funktionen, Klassen)</a></li></ul></div>
</div>




    
    
    
    





    
    
        
        
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-podcast"></i> Videos (HSBI-Medienportal)</div>
  <div class="box-content">

<ul> <li><a href='https://www.hsbi.de/medienportal/m/725097f1ce3ef3f10dd1d31674e1b18e89e8b58af259705080b78ccba9dd319d7be76884549c9c59e02fde9e1a2a91ae5aa3a6d44a8e200a2323e08e217faa14' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>VL AST-basierte Interpreter (Funktionen, Klassen)</a></li></ul></div>
</div>




    
    





    

    

    
    
        
        
        
        
    
        
        
        
        
    
        
        
        
        
    
    

    
<div class="box notices cstyle tip">
  <div class="box-label"><i class="fas fa-lightbulb"></i> Lernziele</div>
  <div class="box-content">

<ul> <li>(K3) Traversierung von Parse-Trees und Implementierung von Aktionen mit Hilfe des Visitor-Patterns</li> <li>(K3) Interpreter m√ºssen Namen und Werte speichern: Environment-Strukturen analog zu den Symboltabellen</li> <li>(K3) Code-Ausf√ºhrung im Interpreter durch eine Read-Eval-Schleife: Implementierung mit einem Visitor</li></ul></div>
</div>




    <h2 id="funktionen">Funktionen</h2>
<div class='columns'>
<div class='column'>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">foo</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> a<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> b<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> c<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    print a <span style="color:#f92672">+</span> b <span style="color:#f92672">+</span> c<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>foo<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">);</span></span></span></code></pre></div></div>
<div class='column'>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">makeCounter</span>():
</span></span><span style="display:flex;"><span>    var i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">count</span>():
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">=</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        print i
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> count;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>counter <span style="color:#f92672">=</span> makeCounter()
</span></span><span style="display:flex;"><span>counter()   <span style="color:#75715e"># &#34;1&#34;</span>
</span></span><span style="display:flex;"><span>counter()   <span style="color:#75715e"># &#34;2&#34;</span></span></span></code></pre></div></div>
</div>
<p>Die Funktionsdeklaration muss im aktuellen Kontext abgelegt werden,
dazu wird der AST-Teilbaum der Deklaration ben√∂tigt.</p>
<p>Beim Aufruf muss man das Funktionssymbol im aktuellen Kontext
suchen, die Argumente auswerten, einen neuen lokalen Kontext
anlegen und darin die Parameter definieren (mit den eben ausgewerteten
Werten) und anschlie√üend den AST-Teilbaum des Funktionsk√∂rpers im
Interpreter mit <code>eval()</code> auswerten ...</p>
<h2 id="ausf√ºhren-einer-funktionsdeklaration">Ausf√ºhren einer Funktionsdeklaration</h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>funcDecl : type <span style="color:#66d9ef">ID</span> <span style="color:#e6db74">&#39;(&#39;</span> params<span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;)&#39;</span> block ;
</span></span><span style="display:flex;"><span>funcCall : <span style="color:#66d9ef">ID</span> <span style="color:#e6db74">&#39;(&#39;</span> exprList<span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;)&#39;</span> ;</span></span></code></pre></div><div class='columns'>
<div class='column'>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">funcDecl</span>(self, AST t):
</span></span><span style="display:flex;"><span>    fn <span style="color:#f92672">=</span> Fun(t, self<span style="color:#f92672">.</span>env)
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>define(t<span style="color:#f92672">.</span>ID()<span style="color:#f92672">.</span>getText(), fn)</span></span></code></pre></div></div>
<div class='column'>
<p><a href="#R-image-af9337957a19977686bc4ebc41c615fd" class="lightbox-link"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/astdriven-part2/fun.png?width=auto&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: auto;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-af9337957a19977686bc4ebc41c615fd"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/astdriven-part2/fun.png?width=auto&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
</div>
</div>
<p><span class='origin'>Quelle: Eigener Code basierend auf einer Idee nach <a href="https://github.com/munificent/craftinginterpreters/blob/master/java/com/craftinginterpreters/lox/LoxFunction.java#L6" target="_blank">LoxFunction.java</a> by <a href="https://github.com/munificent" target="_blank">Bob Nystrom</a> on Github.com (<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">MIT</a>)</span></p>
<p>Man definiert im aktuellen Environment den Funktionsnamen und h√§lt dazu
den aktuellen Kontext (aktuelles Environment) sowie den AST-Knoten mit
der eigentlichen Funktionsdefinition fest.</p>
<p>F√ºr <em>Closures</em> ist der aktuelle Kontext wichtig, sobald man die
Funktion ausf√ºhren muss. In <a href="#id_Parr2010">[Parr2010, S.236]</a> wird beispielsweise
einfach nur ein neuer Memory-Space (entspricht ungef√§hr hier einem
neuen lokalen Environment) angelegt, in dem die im Funktionsk√∂rper
definierten Symbole angelegt werden. Die Suche nach Symbolen erfolgt
dort nur im Memory-Space (Environment) der Funktion bzw. im globalen
Scope (Environment).</p>
<h2 id="ausf√ºhren-eines-funktionsaufrufs">Ausf√ºhren eines Funktionsaufrufs</h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>funcDecl : type <span style="color:#66d9ef">ID</span> <span style="color:#e6db74">&#39;(&#39;</span> params<span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;)&#39;</span> block ;
</span></span><span style="display:flex;"><span>funcCall : <span style="color:#66d9ef">ID</span> <span style="color:#e6db74">&#39;(&#39;</span> exprList<span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;)&#39;</span> ;</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">funcCall</span>(self, AST t):
</span></span><span style="display:flex;"><span>    fn <span style="color:#f92672">=</span> (Fun)eval(t<span style="color:#f92672">.</span>ID())
</span></span><span style="display:flex;"><span>    args <span style="color:#f92672">=</span> [eval(a)  <span style="color:#66d9ef">for</span> a <span style="color:#f92672">in</span> t<span style="color:#f92672">.</span>exprList()]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    prev <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>env;  self<span style="color:#f92672">.</span>env <span style="color:#f92672">=</span> Environment(fn<span style="color:#f92672">.</span>closure)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(args<span style="color:#f92672">.</span>size()):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>define(fn<span style="color:#f92672">.</span>decl<span style="color:#f92672">.</span>params()[i]<span style="color:#f92672">.</span>getText(), args[i])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    eval(fn<span style="color:#f92672">.</span>decl<span style="color:#f92672">.</span>block())
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>env <span style="color:#f92672">=</span> prev</span></span></code></pre></div><p><span class='origin'>Quelle: Eigener Code basierend auf einer Idee nach <a href="https://github.com/munificent/craftinginterpreters/blob/master/java/com/craftinginterpreters/lox/LoxFunction.java#L57" target="_blank">LoxFunction.java</a> by <a href="https://github.com/munificent" target="_blank">Bob Nystrom</a> on Github.com (<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">MIT</a>)</span></p>
<p>Zun√§chst wird die <code>ID</code> im aktuellen Kontext ausgewertet. In der obigen Grammatik
ist dies tats√§chlich nur ein Funktionsname, aber man k√∂nnte √ºber diesen Mechanismus
auch Ausdr√ºcke erlauben und damit Funktionspointer bzw. Funktionsreferenzen
realisieren ... Im Ergebnis hat man das Funktionsobjekt mit dem zugeh√∂rigen AST-Knoten
und dem Kontext zur Deklarationszeit.</p>
<p>Die Argumente der Funktion werden nacheinander ebenfalls im aktuellen Kontext
ausgewertet.</p>
<p>Um den Funktionsblock auszuwerten, legt man einen neuen tempor√§ren Kontext √ºber
dem Closure-Kontext der Funktion an und definiert darin die Parameter der Funktion
samt den aktuellen Werten. Dann l√§sst man den Interpreter √ºber den Visitor-Dispatch
den Funktionsk√∂rper evaluieren und schaltet wieder auf den Kontext vor der
Funktionsauswertung zur√ºck.</p>
<h2 id="funktionsaufruf-r√ºckgabewerte">Funktionsaufruf: R√ºckgabewerte</h2>
<div class='columns'>
<div class='column'>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">funcCall</span>(self, AST t):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    eval(fn<span style="color:#f92672">.</span>decl<span style="color:#f92672">.</span>block())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># (Wirkung)</span></span></span></code></pre></div></div>
<div class='column'>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReturnEx</span>(RuntimeException):
</span></span><span style="display:flex;"><span>    __init__(self, v): self<span style="color:#f92672">.</span>value <span style="color:#f92672">=</span> v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">return</span>(self, AST t):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> ReturnEx(eval(t<span style="color:#f92672">.</span>expr()))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">funcCall</span>(self, AST t):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    erg <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>: eval(fn<span style="color:#f92672">.</span>decl<span style="color:#f92672">.</span>block())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> ReturnEx <span style="color:#66d9ef">as</span> r: erg <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>value
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> erg;</span></span></code></pre></div></div>
</div>
<p><span class='origin'>Quelle: Eigener Code basierend auf einer Idee nach <a href="https://github.com/munificent/craftinginterpreters/blob/master/java/com/craftinginterpreters/lox/Return.java#L4" target="_blank">Return.java</a> und <a href="https://github.com/munificent/craftinginterpreters/blob/master/java/com/craftinginterpreters/lox/LoxFunction.java#L74" target="_blank">LoxFunction.java</a> by <a href="https://github.com/munificent" target="_blank">Bob Nystrom</a> on Github.com (<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">MIT</a>)</span></p>
<p>R√ºckgabewerte f√ºr den Funktionsaufruf werden innerhalb von <code>block</code> berechnet,
wo eine Reihe von Anweisungen interpretiert werden, weshalb <code>block</code> urspr√ºnglich
keinen R√ºckgabewert hat. Im Prinzip k√∂nnte man <code>block</code> etwas zur√ºck geben lassen,
was durch die m√∂glicherweise tiefe Rekursion relativ umst√§ndlich werden kann.</p>
<p>An dieser Stelle kann man den Exceptions-Mechanismus <strong>missbrauchen</strong> und bei
der Auswertung eines <code>return</code> mit dem Ergebniswert direkt zum Funktionsaufruf
zur√ºck springen. In Methoden, wo man einen neuen lokalen Kontext anlegt und
die globale <code>env</code>-Variable tempor√§r damit ersetzt, muss man dann ebenfalls
mit <code>try/catch</code> arbeiten und im <code>finally</code>-Block die Umgebung zur√ºcksetzen und
die Exception erneut werfen.</p>
<h2 id="native-funktionen">Native Funktionen</h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Callable</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">call</span>(self, Interpreter i, List<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> a): <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Fun</span>(Callable): <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NativePrint</span>(Fun):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">call</span>(self, Interpreter i, List<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> a):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> o <span style="color:#f92672">in</span> a: print a  <span style="color:#75715e"># nur zur Demo, hier sinnvoller Code :-)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Im Interpreter (Initialisierung):</span>
</span></span><span style="display:flex;"><span>self<span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>define(<span style="color:#e6db74">&#34;print&#34;</span>, NativePrint())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">funcCall</span>(self, AST t):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    prev = self.env;  self.env = Environment(fn.closure)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    for i in range(args.size()): ...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#    eval(fn.decl.block()); self.env = prev</span>
</span></span><span style="display:flex;"><span>    fn<span style="color:#f92672">.</span>call(self, args)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span></span></span></code></pre></div><p><span class='origin'>Quelle: Eigener Code basierend auf einer Idee nach <a href="https://github.com/munificent/craftinginterpreters/blob/master/java/com/craftinginterpreters/lox/LoxCallable.java#L6" target="_blank">LoxCallable.java</a> und <a href="https://github.com/munificent/craftinginterpreters/blob/master/java/com/craftinginterpreters/lox/LoxFunction.java#L6" target="_blank">LoxFunction.java</a> by <a href="https://github.com/munificent" target="_blank">Bob Nystrom</a> on Github.com (<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">MIT</a>)</span></p>
<p>Normalerweise wird beim Interpretieren eines Funktionsaufrufs der
Funktionsk√∂rper (repr√§sentiert durch den entsprechenden AST-Teilbaum)
durch einen rekursiven Aufruf von <code>eval</code> ausgewertet.</p>
<p>F√ºr native Funktionen, die im Interpreter eingebettet sind, klappt
das nicht mehr, da hier kein AST vorliegt.</p>
<p>Man erstellt ein neues Interface <code>Callable</code> mit der Hauptmethode <code>call()</code>
und leitet die fr√ºhere Klasse <code>Fun</code> davon ab: <code>class Fun(Callable)</code>.
Die Methode <code>funcCall()</code> des Interpreters ruft nun statt der <code>eval()</code>-Methode
die <code>call()</code>-Methode des Funktionsobjekts auf und √ºbergibt den Interpreter
(== Zustand) und die Argumente. Die <code>call()</code>-Methode der Klasse <code>Fun</code> muss
nun ihrerseits im Normalfall den im Funktionsobjekt referenzierten AST-Teilbaum
des Funktionsk√∂rpers mit dem Aufruf von <code>eval()</code> interpretieren ...</p>
<p><a href="#R-image-b123d0159df731e9c696e55ecc866823" class="lightbox-link"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/astdriven-part2/callFun.png?width=auto&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: auto;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-b123d0159df731e9c696e55ecc866823"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/astdriven-part2/callFun.png?width=auto&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
<p>F√ºr die nativen Funktionen leitet man einfach eine (anonyme) Klasse
ab und speichert sie unter dem gew√ºnschten Namen im globalen Kontext
des Interpreters. Die <code>call()</code>-Methode wird dann entsprechend der
gew√ºnschten Funktion implementiert, d.h. hier erfolgt kein weiteres
Auswerten des AST.</p>
<h2 id="klassen-und-instanzen-i">Klassen und Instanzen I</h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>classDef : <span style="color:#e6db74">&#34;class&#34;</span> <span style="color:#66d9ef">ID</span> <span style="color:#e6db74">&#34;{&#34;</span> funcDecl<span style="color:#f92672">*</span> <span style="color:#e6db74">&#34;}&#34;</span> ;</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">classDef</span>(self, AST t):
</span></span><span style="display:flex;"><span>    methods <span style="color:#f92672">=</span> HashMap<span style="color:#f92672">&lt;</span>String, Fun<span style="color:#f92672">&gt;</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> t<span style="color:#f92672">.</span>funcDecl():
</span></span><span style="display:flex;"><span>        fn <span style="color:#f92672">=</span> Fun(m, self<span style="color:#f92672">.</span>env)
</span></span><span style="display:flex;"><span>        methods[m<span style="color:#f92672">.</span>ID()<span style="color:#f92672">.</span>getText()] <span style="color:#f92672">=</span> fn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    clazz <span style="color:#f92672">=</span> Clazz(methods)
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>define(t<span style="color:#f92672">.</span>ID()<span style="color:#f92672">.</span>getText(), clazz)</span></span></code></pre></div><p><span class='origin'>Quelle: Eigener Code basierend auf einer Idee nach <a href="https://github.com/munificent/craftinginterpreters/blob/master/java/com/craftinginterpreters/lox/Interpreter.java#L115" target="_blank">Interpreter.java</a> by <a href="https://github.com/munificent" target="_blank">Bob Nystrom</a> on Github.com (<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">MIT</a>)</span></p>
<p><strong>Anmerkung</strong>: In dieser Darstellung wird der Einfachheit halber nur auf Methoden eingegangen.
F√ºr Attribute m√ºssten √§hnliche Konstrukte implementiert werden.</p>
<h2 id="klassen-und-instanzen-ii">Klassen und Instanzen II</h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Clazz</span>(Callable):
</span></span><span style="display:flex;"><span>    __init__(self, Map<span style="color:#f92672">&lt;</span>String, Fun<span style="color:#f92672">&gt;</span> methods):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>methods <span style="color:#f92672">=</span> methods
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">call</span>(self, Interpreter i, List<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> a):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Instance(self)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">findMethod</span>(self, String name):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>methods[name]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Instance</span>:
</span></span><span style="display:flex;"><span>    __init__(self, Clazz clazz):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>clazz <span style="color:#f92672">=</span> clazz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self, String name):
</span></span><span style="display:flex;"><span>        method <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>clazz<span style="color:#f92672">.</span>findMethod(name)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> method <span style="color:#f92672">!=</span> <span style="color:#66d9ef">None</span>: <span style="color:#66d9ef">return</span> method<span style="color:#f92672">.</span>bind(self)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(name, <span style="color:#e6db74">&#34;undefined method&#34;</span>)</span></span></code></pre></div><p><span class='origin'>Quelle: Eigener Code basierend auf einer Idee nach <a href="https://github.com/munificent/craftinginterpreters/blob/master/java/com/craftinginterpreters/lox/LoxClass.java#L11" target="_blank">LoxClass.java</a> und <a href="https://github.com/munificent/craftinginterpreters/blob/master/java/com/craftinginterpreters/lox/LoxInstance.java#L7" target="_blank">LoxInstance.java</a> by <a href="https://github.com/munificent" target="_blank">Bob Nystrom</a> on Github.com (<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">MIT</a>)</span></p>
<p>Instanzen einer Klasse werden durch den funktionsartigen &quot;Aufruf&quot; der Klassen
angelegt (parameterloser Konstruktor). Eine Instanz h√§lt die Attribute (hier
nicht gezeigt) und eine Referenz auf die Klasse, um sp√§ter an die Methoden
heranzukommen.</p>
<h2 id="zugriff-auf-methoden-und-attribute">Zugriff auf Methoden (und Attribute)</h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-antlr" data-lang="antlr"><span style="display:flex;"><span>getExpr : obj <span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#66d9ef">ID</span> ;</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getExpr</span>(self, AST t):
</span></span><span style="display:flex;"><span>    obj <span style="color:#f92672">=</span> eval(t<span style="color:#f92672">.</span>obj())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isinstance(obj, Instance):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ((Instance)obj)<span style="color:#f92672">.</span>get(t<span style="color:#f92672">.</span>ID()<span style="color:#f92672">.</span>getText())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(t<span style="color:#f92672">.</span>obj()<span style="color:#f92672">.</span>getText(), <span style="color:#e6db74">&#34;no object&#34;</span>)</span></span></code></pre></div><p>Beim Zugriff auf Attribute muss das Objekt im aktuellen Kontext evaluiert
werden. Falls es eine Instanz von <code>Instance</code> ist, wird auf das Feld per
interner Hash-Map zugriffen; sonst Exception.</p>
<h2 id="methoden-und-this-oder-self">Methoden und <em>this</em> oder <em>self</em></h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Fun</span>(Callable):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bind</span>(self, Instance i):
</span></span><span style="display:flex;"><span>        e <span style="color:#f92672">=</span> Environment(self<span style="color:#f92672">.</span>closure)
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span>define(<span style="color:#e6db74">&#34;this&#34;</span>, i)
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span>define(<span style="color:#e6db74">&#34;self&#34;</span>, i)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Fun(self<span style="color:#f92672">.</span>decl, e)</span></span></code></pre></div><p><span class='origin'>Quelle: Eigener Code basierend auf einer Idee nach <a href="https://github.com/munificent/craftinginterpreters/blob/master/java/com/craftinginterpreters/lox/LoxFunction.java#L31" target="_blank">LoxFunction.java</a> by <a href="https://github.com/munificent" target="_blank">Bob Nystrom</a> on Github.com (<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">MIT</a>)</span></p>
<p>Nach dem Interpretieren von Klassendefinitionen sind die Methoden in der Klasse
selbst gespeichert, wobei der jeweilige <code>closure</code> auf den Klassenkontext zeigt.</p>
<p>Beim Aufl√∂sen eines Methodenaufrufs wird die gefundene Methode an die
Instanz gebunden, d.h. es wird eine neue Funktion angelegt, deren <code>closure</code>
auf den Kontext der Instanz zeigt. Zus√§tzlich wird in diesem Kontext noch die
Variable &quot;<code>this</code>&quot; definiert, damit man damit auf die Instanz zugreifen kann.</p>
<p>In Python wird das in der Methodensignatur sichtbar: Der erste Parameter ist
eine Referenz auf die Instanz, auf der diese Methode ausgef√ºhrt werden soll ...</p>
<h2 id="wrap-up">Wrap-Up</h2>
<ul>
<li>
<p>Interpreter simulieren die Programmausf√ºhrung</p>
<ul>
<li>Namen und Symbole aufl√∂sen</li>
<li>Speicherbereiche simulieren</li>
<li>Code ausf√ºhren: Read-Eval-Loop</li>
</ul>
</li>
<li>
<p>Traversierung des AST: <code>eval(AST t)</code> als Visitor-Dispatcher</p>
</li>
<li>
<p>Scopes mit <code>Environment</code> (analog zu Symboltabellen)</p>
</li>
<li>
<p>Interpretation von Funktionen (Deklaration/Aufruf, native Funktionen)</p>
</li>
<li>
<p>Interpretation von Klassen und Instanzen</p>
</li>
</ul>


    



    



    

    
<div class="box notices cstyle note">
  <div class="box-label"><i class="fas fa-puzzle-piece"></i> Challenges</div>
  <div class="box-content">

<ul>
<li>Wie interpretiert man Code?</li>
<li>Warum kann man die Werte nicht einfach in Symboltabellen ablegen?</li>
<li>Wie geht man mit Funktionen um? Warum? Kann man diese mehrfach aufrufen?</li>
<li>Wieso erzeugt man eine neue Environment mit der Closure in der Funktion?</li>
<li>Wie gehen native Funktionen?</li>
</ul>
<p>Betrachten Sie folgenden Code-Ausschnitt:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">f</span>(<span style="color:#66d9ef">int</span> x) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> y <span style="color:#f92672">=</span> <span style="color:#ae81ff">9</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y<span style="color:#f92672">+</span>x;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> <span style="color:#a6e22e">f</span>(x);</span></span></code></pre></div><ol>
<li>Geben Sie den AST an.</li>
<li>Stellen Sie die Strukturen der Symboltabelle dar.</li>
<li>Stellen Sie die Strukturen im Interpreter dar.</li>
</ol>
</div>
</div>



    





    




    
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
            
            
                
            
            
        
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
                    
                
            
            
                
            
            
        
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
            
            
                
            
            
        
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
            
            
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-book-reader"></i> Quellen</div>
  <div class="box-content">

<ul> <li id='id_Grune2012'>[Grune2012] <strong>Modern Compiler Design</strong><br>Grune, D. und van, Reeuwijk, K. und Bal, H. E. und Jacobs, C. J. H. und Langendoen, K., Springer, 2012. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-1-4614-4698-9' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-1-4614-4698-9</a>.<br><em>Kapitel 6</em></li> <li id='id_Mogensen2017'>[Mogensen2017] <strong>Introduction to Compiler Design</strong><br>Mogensen, T., Springer, 2017. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-3-319-66966-3' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-3-319-66966-3</a>. DOI <a href='https://doi.org/10.1007/978-3-319-66966-3' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>10.1007/978-3-319-66966-3</a>.<br><em>Kapitel 4</em></li> <li id='id_Nystrom2021'>[Nystrom2021] <a href='https://github.com/munificent/craftinginterpreters' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'><strong>Crafting Interpreters</strong></a><br>Nystrom, R., Genever Benning, 2021. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-0-9905829-3-9' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-0-9905829-3-9</a>.<br><em>Kapitel Kapitel: A Tree-Walk Interpreter, insb. 10. Functions u. 12. Classes</em></li> <li id='id_Parr2010'>[Parr2010] <strong>Language Implementation Patterns</strong><br>Parr, T., Pragmatic Bookshelf, 2010. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-1-9343-5645-6' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-1-9343-5645-6</a>.</li></ul></div>
</div>






<footer class="footline"><div style="color: darkgray; font-size: small;">
<p style="margin: 4rem;">
<!-- https://creativecommons.org/choose/ -->
<a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0;margin:0;display:inline;" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
Unless otherwise noted, <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master">this work</a> by <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/bcg7" property="cc:attributionName" rel="cc:attributionURL">BC George</a>, <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/cagix" property="cc:attributionName" rel="cc:attributionURL">Carsten Gips</a>, and <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/graphs/contributors">contributors</a> is licensed under <a rel="license" href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/LICENSE.md">CC BY-SA 4.0</a>.
See the <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/CREDITS.md">credits</a> for a detailed list of contributing projects.

</p>
</div>

</footer>
</article>

<article class="default">
<h1>Garbage Collection</h1>



    



    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-graduation-cap"></i> TL;DR</div>
  <div class="box-content">

<p>Bei der Abarbeitung des Bytecodes in der VM werden immer wieder Objekte auf dem Laufzeit-Heap angelegt.
Nicht ben√∂tigte Objekte m√ºssen von Zeit zu Zeit wieder frei gegeben werden.</p>
<p>F√ºr die <strong>Mark-Sweep-Garbage-Collection</strong> pflegt man in der VM eine verkettete Liste aller Objekte, die
auf dem Heap angelegt werden. Bei der Durchf√ºhrung eines Mark-Sweep-Laufs markiert man zun√§chst alle
&quot;Wurzeln&quot;, d.h. die √ºber den Stack der VM oder die Hashtabelle der VM mit den globalen Variablen und
Funktionen oder die Konstanten-Arrays der VM direkt erreichbaren Objekte. Von hier aus traversiert man
alle verwiesenen Objekte und markiert diese ebenfalls. Anschlie√üend iteriert man √ºber die verkettete
Liste aller Objekte in der VM und entfernt alle Objekte, die im vorigen Schritt nicht markiert wurden.</p>
<p>Wenn man GC zu selten durchf√ºhrt, dauert ein GC-Lauf u.U. sehr lange (viele Objekte): hohe Latenz.
Wenn man GC zu oft durchf√ºhrt, dauert ein einzelner Lauf zwar nur recht kurz, aber das Verh√§ltnis
von Zeit im &quot;User-Modus&quot; vs. Zeit im &quot;GC-Modus&quot; wird ebenfalls schlecht: niedriger Durchsatz. Hier
kann man mit der Heuristik des &quot;self-adjusting&quot; Heaps arbeiten: Wenn die Gesamtgr√∂√üe der allozierten
Objekte einen Schwellwert √ºberschreitet, f√ºhrt man GC durch und vergr√∂√üert den Schwellwert: Gr√∂√üe der
verbleibenden Objekte multipliziert mit einem Faktor.</p>
</div>
</div>




    
    
    
    





    
    
        
        
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-podcast"></i> Videos (YouTube)</div>
  <div class="box-content">

<ul> <li><a href='https://youtu.be/Loo3Ver5pyc' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>VL Garbage Collection</a></li></ul></div>
</div>




    
    
    
    





    
    
        
        
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-podcast"></i> Videos (HSBI-Medienportal)</div>
  <div class="box-content">

<ul> <li><a href='https://www.hsbi.de/medienportal/m/6f634388ae21b10f85827208a3a00606fef9550c5ab1fb94fd750ff0f6ebf24f9e1873213cb14c93406b2512041a49bc3bede5a995750d82ce6299669476b4b3' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>VL Garbage Collection</a></li></ul></div>
</div>




    
    





    

    

    
    
        
        
        
        
    
    

    
<div class="box notices cstyle tip">
  <div class="box-label"><i class="fas fa-lightbulb"></i> Lernziele</div>
  <div class="box-content">

<ul> <li>(K3) Prinzipien der Garbage Collection</li></ul></div>
</div>




    <h2 id="ist-das-code-oder-kann-das-weg">Ist das Code oder kann das weg?</h2>
<div class='columns'>
<div class='column'>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>x <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;wuppie&#39;</span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;fluppie&#39;</span>
</span></span><span style="display:flex;"><span>print(y)</span></span></code></pre></div></div>
<div class='column'>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">foo</span>():
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;wuppie&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bar</span>():
</span></span><span style="display:flex;"><span>        print(x)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fn <span style="color:#f92672">=</span> foo()
</span></span><span style="display:flex;"><span>fn()</span></span></code></pre></div></div>
</div>
<p>Bei der Erzeugung von Bytecode f√ºr eine VM kann man die Konstanten direkt in einem
Konstanten-Array sammeln und im Bytecode mit den entsprechenden Indizes arbeiten.
Das entspricht dem Vorgehen bei der Maschinencode-Erzeugung, dort sammelt man die
Konstanten typischerweise am Ende des Text-Segments.</p>
<p>Bei der Abarbeitung des Bytecodes durch die VM legt diese Objekte f√ºr globale und
lokale Variablen, Strings sowie f√ºr Funktionen etc. an. Der Speicher daf√ºr wird
dynamisch auf dem Heap reserviert, und die Adressen beispielsweise im Stack (bei
lokalen Variablen) oder in Hashtabellen (Funktionsnamen, globale Variablen) o.√§.
gespeichert.</p>
<p>Wenn Objekte nicht mehr ben√∂tigt werden, sollten sie entsprechend wieder freigegeben
werden, da sonst der Heap der VM voll l√§uft. Im obigen Beispiel wird der Speicher
f√ºr <code>wuppie</code> unerreichbar, sobald man die Zuweisung <code>y = 'fluppie'</code> ausf√ºhrt.
Andererseits darf man aber auch nicht zu gro√üz√ºgig Objekt aufr√§umen: Die lokale
Variable <code>x</code> in <code>foo</code> wird in der beim Aufruf erzeugten Funktion <code>bar</code> ben√∂tigt
(<em>Closure</em>) und muss deshalb von der Lebensdauer wie eine globale Variable behandelt
werden.</p>
<h2 id="erreichbarkeit">Erreichbarkeit</h2>
<p><a href="#R-image-ad34c848fda05222433279e7d534af67" class="lightbox-link"><img src="https://raw.githubusercontent.com/munificent/craftinginterpreters/master/site/image/garbage-collection/reachable.png?width=auto&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: auto;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-ad34c848fda05222433279e7d534af67"><img src="https://raw.githubusercontent.com/munificent/craftinginterpreters/master/site/image/garbage-collection/reachable.png?width=auto&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
<p><span class='origin'>Quelle: <a href="https://github.com/munificent/craftinginterpreters/blob/master/site/image/garbage-collection/reachable.png" target="_blank">reachable.png</a> by <a href="https://github.com/munificent" target="_blank">Bob Nystrom</a> on Github.com (<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">MIT</a>)</span></p>
<ol>
<li>
<p>Erreichbar sind zun√§chst alle &quot;Wurzeln&quot;, d.h. alle Objekte, die direkt √ºber den
Stack oder die Konstanten-Arrays oder die Hashtabelle mit den globalen Variablen
(und Funktionen) erreichbar sind.</p>
</li>
<li>
<p>Alle Objekte, die von erreichbaren Objekten aus erreichbar sind, sind ebenfalls
erreichbar.</p>
</li>
</ol>
<p>&quot;Objekt&quot; meint dabei im Zuge der Bytecode-Generierung oder w√§hrend der Bearbeitung
durch die VM erstellte Werte/Objekte, die auf dem Heap alloziert wurden und durch
die VM aktiv freigegeben werden m√ºssen.</p>
<h2 id="pr√§zises-gc-mark-sweep-garbage-collection">&quot;Pr√§zises GC&quot;: Mark-Sweep Garbage Collection</h2>
<p>Das f√ºhrt zu einem zweistufigen Algorithmus:</p>
<ol>
<li><strong>Mark</strong>: Starte mit den Wurzeln und traversiere so lange durch die Objektreferenzen,
bis alle erreichbaren Objekte besucht wurden.</li>
<li><strong>Sweep</strong>: L√∂sche alle anderen Objekte.</li>
</ol>
<p><a href="#R-image-7798ac2eb4154f182527d86cc0702fb1" class="lightbox-link"><img src="https://raw.githubusercontent.com/munificent/craftinginterpreters/master/site/image/garbage-collection/mark-sweep.png?width=auto&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: auto;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-7798ac2eb4154f182527d86cc0702fb1"><img src="https://raw.githubusercontent.com/munificent/craftinginterpreters/master/site/image/garbage-collection/mark-sweep.png?width=auto&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
<p><span class='origin'>Quelle: <a href="https://github.com/munificent/craftinginterpreters/blob/master/site/image/garbage-collection/mark-sweep.png" target="_blank">mark-sweep.png</a> by <a href="https://github.com/munificent" target="_blank">Bob Nystrom</a> on Github.com (<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">MIT</a>)</span></p>
<p>Die Strukturen f√ºr Objekte und die VM werden erg√§nzt: Objekte erhalten noch
ein Flag f√ºr die Markierung.</p>
<p>Zum Auffinden der erreichbaren Objekte wird mit einem F√§rbungsalgorithmus
gearbeitet. Initial sind alle Objekte &quot;wei√ü&quot; (nicht markiert).</p>
<h3 id="phase-mark-wurzeln-markieren">Phase &quot;Mark&quot;: Wurzeln markieren</h3>
<p>Im ersten Schritt f√§rbt man alle &quot;Wurzeln&quot; &quot;grau&quot; ein. Dabei werden alle
Objektreferenzen im Stack der VM, in der Hashtabelle f√ºr globale Variablen
der VM, in der Konstantentabelle des Bytecode-Chunks sowie in den Funktionspointern
betrachtet: √úber diese Datenstrukturen wird iteriert und alle auf dem Heap
der Laufzeitumgebung allozierten Strukturen/Objekte werden markiert, indem
ihr Flag gesetzt wird. Zus√§tzlich werden die Pointer auf diese Objekte in
einen &quot;<code>grayStack</code>&quot; hinzugef√ºgt. Damit sind alle Wurzeln &quot;grau&quot; markiert&quot;.</p>
<h3 id="phase-mark-trace">Phase &quot;Mark&quot;: Trace</h3>
<p>Nachdem alle Wurzeln &quot;grau&quot; markiert wurden und auf den <code>grayStack</code> der VM
gelegt wurden, m√ºssen nun m√∂gliche Verweise in den Wurzeln verfolgt werden.
Dazu entfernt man schrittweise die Objekte vom Stack und betrachtet sie damit
als &quot;schwarz&quot;. (Das Markierungs-Flag bleibt gesetzt, &quot;schwarz&quot; sind die &quot;grau&quot;
markierten Objekte, weil sie nicht mehr auf dem <code>grayStack</code> der VM liegen.)
Sofern das aktuell betrachtete Objekt seinerseits wieder Referenzen hat
(beispielsweise haben Funktionen wieder einen Bytecode-Chunk mit einem
Konstanten-Array), werden diese Referenzen iteriert und alle dabei aufgefundenen
Objekte auf den <code>grayStack</code> der VM gelegt und ihr Flag gesetzt.</p>
<p>Dieser Prozess wird so lange durchgef√ºhrt, bis der <code>grayStack</code> leer ist. Dann
sind alle erreichbaren Objekte markiert.</p>
<h3 id="phase-sweep">Phase &quot;Sweep&quot;</h3>
<p>Jetzt sind alle erreichbaren Objekte markiert. Objekte, deren Flag nicht gesetzt
ist, sind nicht mehr erreichbar und k√∂nnen freigegeben werden.</p>
<p>Wenn die Objekte nicht erreichbar sind, wie kommt man dann an diese heran?</p>
<p>Die Strukturen f√ºr Objekte und die VM werden erneut erg√§nzt: Objekte erhalten noch
einen <code>next</code>-Pointer, mit dem <em>alle</em> Objekte in einer verketteten Liste gehalten
werden k√∂nnen.</p>
<p>Wann immer f√ºr ein Objekt Speicher auf dem Laufzeit-Heap angefordert wird,
wird dieses Objekt in eine verkettete Liste aller Objekte der VM eingeh√§ngt.
√úber diese Liste wird nun iteriert und dabei werden alle &quot;wei√üen&quot; (nicht markierten)
Objekte ausgeh√§ngt und freigegeben.</p>
<p>Zus√§tzlich m√ºssen alle verbleibenden Objekte f√ºr den n√§chsten GC-Lauf wieder
entf√§rbt werden, d.h. die Markierung muss wieder zur√ºckgesetzt werden.</p>
<h3 id="hinweise">Hinweise</h3>
<p>Die Mark-and-Sweep-GC-Variante wird auch &quot;pr√§zises Garbage Collection&quot; genannt,
da dabei <em>alle</em> nicht mehr ben√∂tigten Objekte entfernt werden.</p>
<p>Da w√§hrend der Durchf√ºhrung der GC die Abarbeitung des Programms pausiert wird,
hat sich deshalb auch die Bezeichnung <em>stop-the-world GC</em> eingeb√ºrgert.</p>
<h2 id="metriken-latenz-und-durchsatz">Metriken: Latenz und Durchsatz</h2>
<ul>
<li>
<p><strong>Latenz</strong>: L√§ngste Zeitdauer, w√§hrend der das eigentliche Programm (des Users)
pausiert, beispielsweise weil gerade eine Garbage Collection l√§uft</p>
</li>
<li>
<p><strong>Durchsatz</strong>: Verh√§ltnis aus Zeit f√ºr den User-Code zu Zeit f√ºr Garbage Collection</p>
<p>Beispiel: Ein Durchsatz von 90% bedeutet, dass 90% der Rechenzeit f√ºr den User
zur Verf√ºgung steht und 10% f√ºr GC verwendet werden.</p>
</li>
</ul>
<p><a href="#R-image-057af3efb9f5982c807a4279b638d16d" class="lightbox-link"><img src="https://raw.githubusercontent.com/munificent/craftinginterpreters/master/site/image/garbage-collection/latency-throughput.png?width=80%25&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: 80%;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-057af3efb9f5982c807a4279b638d16d"><img src="https://raw.githubusercontent.com/munificent/craftinginterpreters/master/site/image/garbage-collection/latency-throughput.png?width=80%25&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
<p><span class='origin'>Quelle: <a href="https://github.com/munificent/craftinginterpreters/blob/master/site/image/garbage-collection/latency-throughput.png" target="_blank">latency-throughput.png</a> by <a href="https://github.com/munificent" target="_blank">Bob Nystrom</a> on Github.com (<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">MIT</a>)</span></p>
<h2 id="heuristik-self-adjusting-heap">Heuristik: Self-adjusting Heap</h2>
<ul>
<li>GC selten: Hohe Latenz (lange Pausen)</li>
<li>GC oft: Geringer Durchsatz</li>
</ul>
<p><strong>Heuristik</strong></p>
<ul>
<li>Beobachte den allozierten Speicher der VM</li>
<li>Wenn vorher festgelegte (willk√ºrliche) Grenze √ºberschritten: GC</li>
<li>Gr√∂√üe des verbliebenen belegten Speichers mal Faktor =&gt; neue Grenze</li>
</ul>
<p>Die Objekte bzw. der Speicherverbrauch, der nach einem GC-Lauf √ºbrig bleibt, ist
ein Indikator f√ºr den aktuell n√∂tigen Speicher. Deshalb setzt man die neue Schwelle,
ab der der n√§chste GC-Lauf gestartet wird, ungef√§hr auf diesen Speicherverbrauch mal
einem gewissen Faktor (beispielsweise den Wert 2), um nicht sofort wieder einen
GC starten zu m√ºssen ...</p>
<h2 id="generational-gc">Generational GC</h2>
<ul>
<li>Teile Heap in zwei Bereiche: &quot;<em>Kinderstube</em>&quot; und &quot;<em>Erwachsenenbereich</em>&quot;</li>
<li>Neue Objekte werden in der Kinderstube angelegt</li>
<li>H√§ufiges GC in Kinderstube</li>
<li>√úberlebende Objekte werden nach 
<span class="math align-center">$N$</span> Generation in den Erwachsenenbereich verschoben</li>
<li>Deutlich selteneres GC im Erwachsenenbereich</li>
</ul>
<p>Die meisten Objekte haben oft eher eine kurze Lebensdauer. Wenn sie aber ein gewisses
&quot;Alter&quot; erreicht haben, werden sie oft noch weiterhin ben√∂tigt.</p>
<p>Man teilt den Heap in zwei unterschiedlich gro√üe Bereiche auf: Die &quot;Kinderstube&quot;
(<em>Nursery</em>) und den gr√∂√üeren Heap-Bereich f√ºr die &quot;Erwachsenen&quot;. Neue Objekte kommen
zun√§chst in die Kinderstube, und dort wird regelm√§√üig GC ausgef√ºhrt. Bei jedem GC-Lauf
wird der Generationen-Z√§hler der &quot;√ºberlebenden&quot; Objekte inkrementiert. Wenn die Objekte
eine bestimmte Anzahl an Generationen √ºberlebt haben, werden sie in den Erwachsenenbereich
verschoben, wo deutlich seltener eine GC durchgef√ºhrt wird.</p>
<h2 id="konservatives-gc-boehm-gc">&quot;Konservatives GC&quot;: Boehm GC</h2>
<p>Man unterscheidet zus√§tzlich noch zwischen <em>konservativem</em> und <em>pr√§zisem</em> GC:</p>
<ul>
<li><em>Konservatives GC</em> geht eher vorsichtig vor: Wenn ein Speicherbereich
m√∂glicherweise noch ben√∂tigt werden <em>k√∂nnte</em>, wird er nicht angefasst;
alles, was auch nur so aussieht wie ein Pointer wird entsprechend behandelt.</li>
<li><em>Pr√§zises GC</em> &quot;weiss&quot; dagegen genau, welche Werte Pointer sind und welche
nicht und handelt entsprechend.</li>
</ul>
<p>Boehm, Weiser und Demers: <a href="https://hboehm.info/gc/" target="_blank">&quot;<strong>Boehm GC</strong>&quot;</a>
=&gt; Konservativer GC (Variante des Mark-and-Sweep-GC)</p>
<p><a href="#R-image-4f81298fd3138179be081871136c7c9e" class="lightbox-link"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/gc/freispeicherverwaltung.png?width=80%25&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: 80%;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-4f81298fd3138179be081871136c7c9e"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/gc/freispeicherverwaltung.png?width=80%25&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
<ul>
<li>Idee: Nutze die interne Verwaltung des Heaps zum Finden von Objekten</li>
</ul>
<h3 id="ablauf">Ablauf</h3>
<ul>
<li><strong>Mark</strong>:
<ol>
<li>Suche alle potentiell zu bereinigenden Objekte: Inspiziere Stack, statische
Daten, Prozessor-Register, ...</li>
<li>Behandle alle gefundenen Adressen zun√§chst als &quot;unsichere Pointer&quot;<br>
Es ist noch nicht klar, ob das wirklich g√ºltige Adressen in den Heap sind ...</li>
<li>Pr√ºfe alle unsicheren Pointer:
<ul>
<li>Liegt die Adresse tats√§chlich <em>im</em> Heap?</li>
<li>Zeigt der Pointer auf den Anfang eines Blockes?</li>
<li>Ist der Block nicht in der Free-List enthalten?
=&gt; Ergebnis: g√ºltige Pointer (&quot;Root-Pointer&quot;): markiere diese Objekte als &quot;erreichbar&quot;</li>
</ul>
</li>
<li>Wiederhole die Schritte (1) bis (3) durch die Untersuchung der gefundenen Objekte</li>
</ol>
</li>
<li><strong>Sweep</strong>: Iteriere √ºber den Heap (blockweise) und gebe alle belegten Bl√∂cke frei, die
nicht als &quot;erreichbar&quot; markiert wurden</li>
</ul>
<h3 id="exkurs-heap-verwaltung">Exkurs Heap-Verwaltung</h3>
<p>Der Heap ist ein zusammenh√§ngender Speicherbereich, der durch die Allokation und Freigabe
von Bl√∂cken in mehrere Bl√∂cke segmentiert wird. Die freien Bl√∂cke werden dabei in eine
verkettete Liste &quot;Free-List&quot; (im Bild &quot;freemem&quot;) eingeh√§ngt. Diese verkettete Liste wird
direkt im Heap abgebildet.</p>
<p>Es wird dazu eine Verwaltungsstruktur definiert, die neben Informationen wie der Gr√∂√üe des
freien Blocks einen Pointer auf den n√§chsten freien Block aufweist. Jeder Speicherblock im
Heap beginnt stets mit dieser Struktur, so dass alle freien Bl√∂cke in die Freispeicherliste
eingeh√§ngt werden k√∂nnen:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> memblock {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> size;
</span></span><span style="display:flex;"><span>    uint marked;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> memblock <span style="color:#f92672">*</span>next;
</span></span><span style="display:flex;"><span>};</span></span></code></pre></div><ul>
<li><code>size</code> kann die Gesamtgr√∂√üe des Blockes bedeuten oder aber nur die Gr√∂√üe der Nutzdaten,
die sich hinter der Verwaltungsstruktur befinden
=&gt; letztere Deutung wird in Linux verwendet</li>
<li>In Linux hat man eine doppelt verkettete Liste (statt wie hier nur einfach verkettet)</li>
</ul>
<p>Bei <code>malloc</code> durchsucht man diese Liste im Heap, bis man einen passenden Block gefunden hat.
Dann setzt man den <code>next</code>-Pointer des Vorg√§ngerblocks auf den Wert des eigenen <code>next</code>-Pointers
und h√§ngt damit den gefundenen Block aus der Freispeicherliste aus. Der <code>next</code>-Pointer wird
ung√ºltig gemacht, indem man ihn auf einen vordefinierten (und nur zu diesem Zweck genutzten)
Wert setzt (alternativ kann man dazu ein weiteres Flag in der Struktur spendieren). Dann
bestimmt man per Pointerarithmetik die Adresse des ersten Bytes hinter der Verwaltungsstruktur
und liefert diese Adresse als Ergebnis (Pointer auf den Nutzbereich des Blockes) an den Aufrufer
zur√ºck. Wenn der gefundene freie Block &quot;viel zu gro√ü&quot; ist, kann man den Block auch splitten:
Einen Teil gibt man als allozierten Block an den Aufrufer zur√ºck, den anderen Teil (den Rest)
h√§ngt man als neuen Block in die Freispeicherliste ein.</p>
<p>Bei einem <code>free</code> bekommt man den Pointer auf das erste Byte der Nutzdaten eines Speicherblockes
und muss per Pointerarithmetik den Beginn der Verwaltungsstruktur des Blockes bestimmen. Dann
setzt man den <code>next</code>-Pointer des Blockes auf den Wert des Freispeicherlisten-Pointers, und
dieser wird auf die Startadresse der Verwaltungsstruktur des Blockes &quot;umgebogen&quot;. Damit hat man
den Block vorn in die Freispeicherliste eingeh√§ngt.</p>
<h3 id="vor--und-nachteile-des-konservativen-gc">Vor- und Nachteile des konservativen GC</h3>
<ul>
<li>(+) Keine explizite Kooperation mit der Speicherverwaltung n√∂tig<br>
Die Speicherverwaltung muss nur eine Bedingung erf√ºllen: Jedes benutzte Objekt hat einen
Pointer auf den Anfang des Blockes</li>
<li>(+) Explizite Deallocation (<code>free</code>) ist m√∂glich</li>
<li>(+) Kann jederzeit abgebrochen werden<br>
Praktisch in Verbindung mit opportunistischer GC in interaktiven Applikationen</li>
<li>(+) Keine separate Buchf√ºhrung √ºber alle in der VM erzeugten Objekte n√∂tig</li>
<li>(-) Mark-Phase dauert durch die zus√§tzlichen Tests l√§nger</li>
<li>(-) Die M√∂glichkeit einer Fragmentierung des Speichers ist hoch</li>
<li>(-) Fehlinterpretationen k√∂nnen daf√ºr sorgen, dass unsichere Pointer nicht freigegeben werden</li>
<li>(-) Bei hoch optimierenden Compilern ist die GC nicht zuverl√§ssig, da die Adressen u.U. nicht
mehr auf die benutzen Objekte zeigen</li>
</ul>
<h2 id="reference-counting">Reference Counting</h2>
<p>Beim Reference Counting erh√§lt jedes Objekt einen Referenz-Z√§hler.</p>
<p>Beim Erstellen weiterer Referenzen oder Pointer auf ein Objekt wird der Z√§hler entsprechend
inkrementiert.</p>
<p>Sobald ein Objekt seinen G√ºltigskeitsbereich (Scope) verl√§sst, wird versucht, das Objekt
freizugeben. Dazu wird der interne Referenz-Z√§hler dekrementiert. Erst wenn der Z√§hler dabei
den Wert 0 erreicht, bedeutet dies, dass es keine weitere Referenz oder Pointer auf dieses Objekt
gibt und das Objekt wird vom Heap entfernt (freigegeben). Wenn der Z√§hler noch gr√∂√üer Null ist,
wird das Objekt nicht weiter ver√§ndert.</p>
<p>Dies ist eine einfach Form des GC, die ohne zyklische Sammelphasen auskommt. Allerdings hat
diese Form ein Problem mit zyklischen Datenstrukturen.</p>
<h3 id="algorithmus-skizze">Algorithmus (Skizze)</h3>
<div class='columns'>
<div class='column'>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">new</span>():
</span></span><span style="display:flex;"><span>    obj <span style="color:#f92672">=</span> alloc_memory()
</span></span><span style="display:flex;"><span>    obj<span style="color:#f92672">.</span>set_ref_counter(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> obj</span></span></code></pre></div><p><code>new()</code> wird beim Erstellen eines Objektes aufgerufen.</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete</span>(obj):
</span></span><span style="display:flex;"><span>    obj<span style="color:#f92672">.</span>dec_ref_counter()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> obj<span style="color:#f92672">.</span>get_ref_counter() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> child <span style="color:#f92672">in</span> children(obj):
</span></span><span style="display:flex;"><span>            delete(child)
</span></span><span style="display:flex;"><span>        free_object(obj)</span></span></code></pre></div><p><code>delete()</code> wird aufgerufen, wenn das Objekt nicht weiter vom Programm verwendet wird, es
beispielsweise seinen Scope verl√§sst. Hierbei wird gepr√ºft, ob noch anderweitig auf dieses
Objekt referenziert wird.</p>
</div>
<div class='column'>
<p><a href="#R-image-acefec3bc3c2367f86350a1526ddb678" class="lightbox-link"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/gc/delete_example.png?width=auto&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: auto;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-acefec3bc3c2367f86350a1526ddb678"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/gc/delete_example.png?width=auto&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
<p>Im Beispiel wird <code>delete(A)</code> ausgef√ºhrt: Der Referenz-Z√§hler (<em>RC</em>) von A wird dekrementiert,
und da er den Wert 0 erreicht, werden rekursiv die von A verwiesenen Kinder gel√∂scht. In B
wird dabei ebenfalls der Wert 0 erreicht und <code>delete(D)</code> aufgerufen. Da dort der RC gr√∂√üer 0
bleibt, wird dessen Kind E nicht weiter beachtet. Anschlie√üend werden A und B aus dem Speicher
freigegeben.</p>
</div>
</div>
<h3 id="probleme">Probleme</h3>
<p>Das gr√∂√üte Problem beim Referenz Counting ist der Umgang mit zyklischen Datenstrukturen, wie
verkettete Listen oder einfache Graphen. Es dazu kommen, dass zyklische Datenstrukturen nicht
gel√∂scht und freigegeben werden k√∂nnen und ein Speicherverlust entsteht.</p>
<p>Das folgende Beispiel erl√§utert dieses Problem:</p>
<p><a href="#R-image-6d881d810cb66f68187a616d37db83d4" class="lightbox-link"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/gc/delete_problem.png?width=80&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: 80;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-6d881d810cb66f68187a616d37db83d4"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/interpretation/gc/delete_problem.png?width=80&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
<h2 id="stop-and-copy-garbage-collection">Stop-and-Copy Garbage Collection</h2>
<ul>
<li>Teile Heap in zwei Bereiche (A und B)</li>
<li>Alloziere nur Speicher aus A (bis der Bereich voll ist)</li>
<li>Stoppe Programmausf√ºhrung und kopiere alle erreichbaren Objekte von A nach B</li>
<li>Gebe gesamten Speicher in A frei</li>
<li>Setze Programmausf√ºhrung mit vertauschten Rollen von A und B fort</li>
</ul>
<h3 id="vor--und-nachteile-von-stop-and-copy-gc">Vor- und Nachteile von Stop-and-Copy GC</h3>
<ul>
<li>(+) Nur ein Lauf √ºber Daten n√∂tig</li>
<li>(+) Automatische Speicherdefragmentierung</li>
<li>(+) Aufwand proportional zur Menge der erreichbaren Objekte und nicht zur Gr√∂√üe des Speichers</li>
<li>(+) Zyklische Referenzen sind kein Problem</li>
<li>(-) Ben√∂tigt doppelten Speicherplatz f√ºr gegebene Heap-Gr√∂√üe</li>
<li>(-) Objekte werden im Speicher bewegt (Update von Referenzen n√∂tig)</li>
<li>(-) Programm muss f√ºr GC angehalten werden</li>
</ul>
<h2 id="benchmarking">Benchmarking</h2>
<h3 id="ziel">Ziel</h3>
<ul>
<li>Vergleich von verschiedenen GC-Algorithmen</li>
<li>Wahl des optimalen Algorithmus f√ºr konkreten Anwendungsfall</li>
<li>Overhead durch GC m√∂glichst gering halten</li>
</ul>
<h3 id="setup">Setup</h3>
<ul>
<li>&quot;Warm up&quot;: einige Iterationen des Benchmarks ohne Messung vorlaufen lassen,
um bspw. Just-in-Time Kompilierung und Initialisierung aller Laufzeitkomponenten abzuschlie√üen</li>
<li>Anpassung der Heap-Gr√∂√üe an den Benchmark (falls Heap zu bestimmter Rate gef√ºllt werden soll)</li>
<li>√úberpr√ºfung und Eliminierung von externen Faktoren, die das Ergebnis beeinflussen k√∂nnen
<ul>
<li>andere Prozesse</li>
<li>dynamische Frequenzskalierung der CPU</li>
<li>Vermeidung von Lese- und Schreibzugriffen, sofern diese nicht durch Test-Infrastruktur vorgegeben sind</li>
</ul>
</li>
</ul>
<h3 id="relevante-metriken-f√ºr-tests">Relevante Metriken f√ºr Tests</h3>
<ul>
<li>Durchsatz (welchen Anteil hat GC an der Laufzeit?)</li>
<li>Latenz (welche Verz√∂gerung erzeugt GC?)</li>
</ul>
<h3 id="szenarien">Szenarien</h3>
<p>(stark vom getesteten GC-Algorithmus abh√§ngig)</p>
<ul>
<li>konstant gef√ºllter Heap/leerer Heap</li>
<li>Erzeugen und L√∂schen von stark referenzierten Objekten/tempor√§ren Objekten</li>
<li>F√ºr Generational GC: Testen von Overhead von Schreib- und Lesebarrieren durch Objektreferenzierung</li>
</ul>
<p><a href="https://ionutbalosin.com/2019/12/jvm-garbage-collectors-benchmarks-report-19-12/" target="_blank">Beispiele f√ºr GC-Benchmarks der JVM</a></p>
<h2 id="wrap-up">Wrap-Up</h2>
<ul>
<li>
<p>Pflege verkette Liste aller Objekte in der VM</p>
</li>
<li>
<p>Mark-Sweep-GC:</p>
<ol>
<li>Markiere alle Wurzeln (&quot;grau&quot;, aus Stack und Hashtabelle)</li>
<li>Traversiere ausgehend von den Wurzeln alle Objekte und markiere sie</li>
<li>Gehe die verkettete Liste aller Objekte durch und entferne alle nicht markierten</li>
</ol>
</li>
<li>
<p>Problem: Latenz und Durchsatz =&gt; Idee des &quot;self-adjusting&quot; Heaps</p>
</li>
<li>
<p>Varianten/Alternativen: Generational GC, Boehm-GC, Reference Counting, Stop-and-Copy GC, ...</p>
</li>
</ul>


    



    



    





    




    
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
            
            
            
        
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
            
            
                
            
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-book-reader"></i> Quellen</div>
  <div class="box-content">

<ul> <li id='id_GCHandbook2011'>[GCHandbook2011] <strong>The Garbage Collection Handbook: The Art of Automatic Memory Management</strong><br>Jones, R. und Hosking, A. und Moss, E., Routledge, 2011. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-1-4200-8279-1' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-1-4200-8279-1</a>.</li> <li id='id_Nystrom2021'>[Nystrom2021] <a href='https://github.com/munificent/craftinginterpreters' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'><strong>Crafting Interpreters</strong></a><br>Nystrom, R., Genever Benning, 2021. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-0-9905829-3-9' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-0-9905829-3-9</a>.<br><em>Kapitel 26: Garbage Collection</em></li></ul></div>
</div>






<footer class="footline"><div style="color: darkgray; font-size: small;">
<p style="margin: 4rem;">
<!-- https://creativecommons.org/choose/ -->
<a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0;margin:0;display:inline;" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
Unless otherwise noted, <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master">this work</a> by <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/bcg7" property="cc:attributionName" rel="cc:attributionURL">BC George</a>, <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/cagix" property="cc:attributionName" rel="cc:attributionURL">Carsten Gips</a>, and <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/graphs/contributors">contributors</a> is licensed under <a rel="license" href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/LICENSE.md">CC BY-SA 4.0</a>.
See the <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/CREDITS.md">credits</a> for a detailed list of contributing projects.

</p>
</div>

</footer>
</article>

          </section>
<article class="default">
<h1>Generierung von Maschinencode (Skizze)</h1>



    



    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-graduation-cap"></i> TL;DR</div>
  <div class="box-content">

<p>Dies ist ein Ausblick und soll die Erzeugung von Maschinencode skizzieren.</p>
<p>Die Erzeugung von Maschinencode ist der Erzeugung von Bytecode relativ √§hnlich, allerdings muss
man die Eigenschaften der Zielhardware (Register, Maschinenbefehle, ...) beachten. Insbesondere
muss man ein Text-Segment erstellen, welches die aus dem Zwischencode √ºbersetzten Maschinenbefehle
enth√§lt. √Ñhnlich wie beim Bytecode werden Konstanten und Literale am Ende vom Text-Segment
gesammelt.</p>
<p>Ein wichtiger (und schwieriger) Schritt ist die Zuordnung von Variablen und Daten zu Registern
oder Adressen. Auch f√ºr Spr√ºnge o.√§. m√ºssen immer wieder Adressen berechnet werden.</p>
<p>Der Aufruf von Funktionen funktioniert √§hnlich wie bei der stackbasierten VM: Die Codegenerierung
muss daf√ºr sorgen, dass f√ºr einen Funktionsaufruf der passende <em>Stack-Frame</em> erzeugt wird und
der Prozessor bei der Ausf√ºhrung in das richtige Code-Segment springt (bei der VM war das einfach:
Die Pointer auf den Byte-Code und der Instruction-Pointer wurden einfach passend &quot;umgebogen&quot;). F√ºr
den R√ºcksprung muss der Instruction-Pointer mit auf dem Stack abgelegt werden.</p>
</div>
</div>




    
    
    
    





    
    
        
        
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-podcast"></i> Videos (YouTube)</div>
  <div class="box-content">

<ul> <li><a href='https://youtu.be/R2anlIWZqGY' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>VL Maschinencode</a></li></ul></div>
</div>




    
    
    
    





    
    
        
        
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-podcast"></i> Videos (HSBI-Medienportal)</div>
  <div class="box-content">

<ul> <li><a href='https://www.hsbi.de/medienportal/m/3321732b51dab72206dd0f6ee1d07449b80c37c2e0880192b38f1e835d10e2c7aea5e75632ea174d44d4d5dbb6864910990cfef160dedd06213ee8ffdf0c9a36' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>VL Maschinencode</a></li></ul></div>
</div>




    
    





    

    

    
    
        
        
        
        
    
    

    
<div class="box notices cstyle tip">
  <div class="box-label"><i class="fas fa-lightbulb"></i> Lernziele</div>
  <div class="box-content">

<ul> <li>(K3) Code-Generierung (Maschinencode) erfordert Aufl√∂sung von Speicheradressen und -breiten</li></ul></div>
</div>




    <h2 id="einordnung">Einordnung</h2>
<p><a href="#R-image-8b75f6ef9a9b33ec9f75d32b498e08c0" class="lightbox-link"><img src="https://raw.githubusercontent.com/munificent/craftinginterpreters/master/site/image/a-map-of-the-territory/mountain.png?width=auto&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: auto;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-8b75f6ef9a9b33ec9f75d32b498e08c0"><img src="https://raw.githubusercontent.com/munificent/craftinginterpreters/master/site/image/a-map-of-the-territory/mountain.png?width=auto&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
<p><span class='origin'>Quelle: <a href="https://github.com/munificent/craftinginterpreters/blob/master/site/image/a-map-of-the-territory/mountain.png" target="_blank">A Map of the Territory (mountain.png)</a> by <a href="https://github.com/munificent" target="_blank">Bob Nystrom</a> on Github.com (<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">MIT</a>)</span></p>
<p>Die Erzeugung von Maschinencode ist in gewisser Weise ein &quot;Parallelweg&quot; zum Erzeugen von
Bytecode. Die Schwierigkeit liegt darin, die <strong>technischen Besonderheiten</strong> der
<strong>Zielplattform</strong> (Register, Maschinenbefehle) gut zu kennen und sinnvoll zu nutzen.</p>
<p>H√§ufig nutzt man als Ausgangsbasis den Drei-Adressen-Code als IR, der strukturell dem zu
erzeugenden Maschinencode bereits recht √§hnlich ist. Oder man macht sich die Sache einfach
und generiert LLVM IR und l√§sst die LLVM-Toolchain √ºbernehmen ;-)</p>
<p>Hier der Vollst√§ndigkeit halber ein Ausblick ...</p>
<h2 id="prozessorarchitektur">Prozessorarchitektur</h2>
<p><span class='origin'>Quelle: <a href="https://commons.wikimedia.org/wiki/File:Intel_i80286_arch.svg" target="_blank">Intel i80286 arch</a> by <a href="https://commons.wikimedia.org/wiki/User:Appaloosa" target="_blank">Appaloosa</a> on Wikimedia.org (<a href="https://creativecommons.org/licenses/by-sa/3.0" target="_blank">CC BY-SA 3.0</a>)</span></p>
<p>Am Beispiel der noch √ºbersichtlichen Struktur des Intel i80286 lassen sich verschiedene
Grundbausteine eines Prozessors identifizieren.</p>
<p>Zun√§chst hat man eine Ausf√ºhrungseinheit (<em>Execution Unit</em>), die sich vor allem aus
verschiedenen Registern und der Recheneinheit (<em>ALU</em>) zusammen setzen. Hier kann man
Adressen berechnen oder eben auch Dinge wie Addition ...</p>
<p>√úber die Register wird auch die Adressierung des Speichers vorgenommen. Aus Sicht eines
Prozesses greift dieser auf einen zusammenh√§ngenden, linearen Speicher zu (&quot;Virtueller
Speicher&quot;, siehe n√§chste Folie). Dieser setzt sich in der Realit√§t aus verschiedenen
Segmenten zusammen, die auch auf unterschiedliche Speichertypen (RAM, Cache, SSD, ...)
verteilt sein k√∂nnen. In der <em>Address Unit</em> werden aus <em>logischen</em> Adressen die konkreten
<em>physikalischen</em> Adressen berechnet.</p>
<p>√úber die <em>Bus Unit</em> erfolgt der physikalische Zugriff auf die konkrete Hardware.</p>
<p>In der <em>Instruction Unit</em> wird der n√§chste Befehl geholt und dekodiert und zur Ausf√ºhrung
gebracht.</p>
<h2 id="virtueller-speicher">Virtueller Speicher</h2>
<p><a href="#R-image-718946f69e789553ceb0cd50abb6f650" class="lightbox-link"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/machinecode/virtueller-speicher.png?width=40%25&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: 40%;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-718946f69e789553ceb0cd50abb6f650"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/machinecode/virtueller-speicher.png?width=40%25&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
<ul>
<li>Kernel weist jedem Prozess seinen eigenen virtuellen Speicher zu<br>
Linearer Adressbereich, beginnend mit Adresse 0 bis zu einer
maximalen Adresse</li>
<li>Verwaltung durch MMU (<em>Memory Management Unit</em>)<br>
MMU bildet logische Adressen aus virtuellem Speicher auf den
physikalischen Speicher ab (transparent f√ºr den Prozess)</li>
</ul>
<h3 id="segmente-des-virtuellen-speichers-text">Segmente des virtuellen Speichers: Text</h3>
<ul>
<li><strong>Text Segment</strong> (read-only)
<ul>
<li>Programm Code</li>
<li>Konstanten, String Literale</li>
</ul>
</li>
<li>Bereich initialisierter Daten
<ul>
<li>globale und static Variablen (explizit initialisiert)</li>
</ul>
</li>
<li>Bereich uninitialisierter Daten
<ul>
<li>globale und static Variablen (uninitialisiert) =&gt; Wert 0</li>
</ul>
</li>
</ul>
<p><strong>ACHTUNG</strong>: Bereich (un-) initialisierter Daten nicht in Abbildung dargestellt!</p>
<h3 id="segmente-des-virtuellen-speichers-stack">Segmente des virtuellen Speichers: Stack</h3>
<ul>
<li>Stackframe je Funktionsaufruf:
<ul>
<li>Lokale Variablen (&quot;automatische&quot; Variablen)</li>
<li>Argumente und Return-Werte</li>
</ul>
</li>
<li>Dynamisch wachsend und schrumpfend</li>
<li><span class='alert'>Automatische</span> Pflege
<ul>
<li>Nach Funktionsr√ºckkehr wird der Stackpointer (&quot;Top of Stack&quot;) weiter gesetzt</li>
<li>Dadurch &quot;Bereinigung&quot;: Speicher der lokalen Variablen wird freigegeben</li>
</ul>
</li>
</ul>
<h3 id="segmente-des-virtuellen-speichers-data-heap">Segmente des virtuellen Speichers: Data (Heap)</h3>
<ul>
<li>Bereich f√ºr dynamischen Speicher (Allokation w√§hrend der Laufzeit)</li>
<li>Dynamisch wachsend und schrumpfend</li>
<li>Zugriff und Verwaltung aus <span class='alert'>laufendem</span> Programm =&gt; <strong>Pointer</strong>
<ul>
<li><code>malloc()</code>/<code>calloc()</code>/<code>free()</code> (C)</li>
<li><code>new</code>/<code>delete</code> (C++)</li>
<li>typischerweise <span class='alert'><strong>Pointer</strong></span></li>
</ul>
</li>
</ul>
<h2 id="befehlszyklus-von-neumann-architektur">Befehlszyklus (von-Neumann-Architektur)</h2>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>op <span style="color:#f92672">=</span> read_next_op(pc)
</span></span><span style="display:flex;"><span>decode(op)
</span></span><span style="display:flex;"><span>pc <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>args <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> operands_needed(op):
</span></span><span style="display:flex;"><span>    args <span style="color:#f92672">=</span> read_operands(pc)
</span></span><span style="display:flex;"><span>    pc <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>execute(op, args)</span></span></code></pre></div><p>Typischerweise hat man neben dem Stack und dem Heap noch diverse Register auf dem Prozessor,
die man wie (schnelle Hardware-) Variablen nutzen kann. Es gibt normalerweise einige spezielle
Register:</p>
<ul>
<li>Program Counter (<em>PC</em>): Zeigt auf die Stelle im Textsegment, die gerade ausgef√ºhrt wird</li>
<li>Stack Pointer (<em>SP</em>): Zeigt auf den n√§chsten freien Stackeintrag</li>
<li>Frame Pointer (<em>FP</em>): Zeigt auf die R√ºcksprungadresse auf dem Stack</li>
<li>Akkumulator: Speichern von Rechenergebnissen</li>
</ul>
<p>Der Prozessor holt sich die Maschinenbefehle, auf die der PC aktuell zeigt und dekodiert sie,
d.h. holt sich die Operanden, und f√ºhrt die Anweisung aus. Danach wird der PC entsprechend
erh√∂ht und der <em>Fetch-Decode-Execute</em>-Zyklus startet erneut. (OK, diese Darstellung ist stark
vereinfacht und l√§sst beispielsweise <em>Pipelining</em> au√üen vor ...)</p>
<p><em>Anmerkung</em>: In der obigen Skizze wird der <em>PC</em> f√ºr jede Instruktion oder jeden Operanden
um 1 erh√∂ht. Dies soll andeuten, dass man die n√§chste Instruktion lesen m√∂chte. In der Realit√§t
muss hier auf die n√§chste relevante Speicheradresse gezeigt werden, d.h. das Inkrement muss
die Breite eines Op-Codes etc. ber√ºcksichtigen.</p>
<p>Ein Sprung bzw. Funktionsaufruf kann erreicht werden, in dem der <em>PC</em> auf die Startadresse der
Funktion gesetzt wird.</p>
<p>Je nach Architektur sind die Register, Adressen und Instruktionen 4 Bytes (32 Bit) oder 8 Bytes
(64 Bit) &quot;breit&quot;.</p>
<h2 id="aufgaben-bei-der-erzeugung-von-maschinen-code">Aufgaben bei der Erzeugung von Maschinen-Code</h2>
<p>Relativ √§hnlich wie bei der Erzeugung von Bytecode, nur muss diesmal die Zielhardware
(Register, Maschinenbefehle, ...) beachtet werden:</p>
<ul>
<li>
<p>√úbersetzen des Zwischencodes in Maschinenbefehle f√ºr die jeweilige Zielhardware</p>
</li>
<li>
<p>Sammeln von Konstanten und Literalen am Ende vom Text-Segment</p>
</li>
<li>
<p>Aufl√∂sen von Adressen:</p>
<ul>
<li>Spr√ºnge: relativ (um wie viele Bytes soll gesprungen werden) oder
absolut (Adresse, zu der gesprungen werden soll)</li>
<li>Strukturen (Arrays, Structs)haben ein Speicherlayout: Zugriff
auf Elemente/Felder √ºber Adresse (muss berechnet werden)</li>
<li>Zugriffe auf Konstanten oder Literalen: Muss ersetzt werden durch
Zugriff auf Text-Segment</li>
</ul>
</li>
<li>
<p>Zuordnung der Variablen und Daten zu Registern oder Adressen</p>
</li>
<li>
<p>Aufruf von Funktionen: Anlegen der <em>Stack-Frames</em> (auch <em>Activation Record</em> genannt)</p>
</li>
<li>
<p>Aufbau des Bin√§rformats und Linking auf der Zielmaschine (auch Betriebssystem) beachten</p>
</li>
</ul>
<h2 id="√ºbersetzen-von-zwischencode-in-maschinencode">√úbersetzen von Zwischencode in Maschinencode</h2>
<p>F√ºr diese Aufgabe muss man den genauen Befehlssatz f√ºr den Zielprozessor kennen.
Im einfachsten Fall kann man jede Zeile im Zwischencode mit Hilfe von Tabellen
und Pattern Matching direkt in den passenden Maschinencode √ºbertragen. Beispiel
vgl. Tabelle 7.1 in <a href="#id_Mogensen2017">[Mogensen2017, S.162]</a>.</p>
<p>Je nach Architektur sind die Register, Adressen und Instruktionen 4 Bytes (32 Bit)
oder 8 Bytes (64 Bit) &quot;breit&quot;.</p>
<p>Da in einer Instruktion wie <code>ldr r0, x</code> die Adresse von <code>x</code> mit codiert werden
muss, hat man hier nur einen eingeschr√§nkten Wertebereich. √úblicherweise ist dies
relativ zum <em>PC</em> zu betrachten, d.h. beispielsweise <code>ldr r0, #4[pc]</code> (4 Byte plus <em>PC</em>).
Dadurch kann man mit <em>PC-relativer Adressierung</em> dennoch gr√∂√üere Adressbereiche
erreichen. Alternativ muss man mit indirekter Adressierung arbeiten und im Textsegment
die Adresse der Variablen im Datensegment ablegen: <code>ldr r0, ax</code>, wobei <code>ax</code> eine
mit <em>PC-relativer Adressierung</em> erreichbare Adresse im Textsegment ist, wo die
Adresse der Variablen <code>x</code> im Datensegment hinterlegt ist. Anschlie√üend kann man
dann <code>x</code> laden: <code>ldr ro, [ro]</code>.</p>
<p>√Ñhnliches gilt f√ºr Konstanten: Wenn diese direkt geladen werden sollen, steht
quasi nur der &quot;Rest&quot; der Bytes vom Opcode zur Verf√ºgung. Deshalb sammelt man die
Konstanten am Ende vom Text-Segment und ruft sie von dort ab.</p>
<div class='columns'>
<div class='column'>
<p><strong>Beispiel</strong></p>
<p>In dem kurzen IR-Snippet soll zum Label &quot;L&quot; verweigt werden, wenn ein Wert x kleiner
ein anderer Wert v ist.</p>
<pre><code>L:  ...
    ...
    if x &lt; v goto L
</code></pre>
</div>
<div class='column'>
<p>Bei der Erzeugung des Maschinencodes wird das Label &quot;L&quot; an einer konkreten Adresse
im Text-Segment angesiedelt, beispielsweise bei 1000. F√ºr die If-Abfrage m√ºssen
zun√§chst die beiden Werte in Register geladen werden und die Register subtrahiert
werden. Anschlie√üend kann man in dem angenommenen Op-Code <code>bltz</code> (&quot;branch if less
than zero&quot;) zur Adresse 1000 springen, wenn der Wert in Register R0 kleiner als Null
ist. Anderenfalls w√ºrde einfach hinter der Adresse 1108 weiter gemacht.</p>
<pre><code>1000: ...               ;; L
      ...
1080: ldr   r0, x       ;; R0 = x
1088: ldr   r1, v       ;; R1 = v
1096: sub   r0, r0, r1  ;; R0 = R0-R1
1108: bltz  r0, 1000    ;; if R0&lt;0 jump to 1000 (L)
</code></pre>
<p><em>Anmerkungen</em>: In der Skizze hier stehen <code>x</code> und <code>v</code> f√ºr die Adressen, wo die
Werte von <code>x</code> und <code>v</code> gespeichert werden. D.h. im Maschinencode steht nicht
<code>x</code>, sondern die Adresse von <code>x</code>.</p>
<p>Beachten Sie auch die unterschiedlichen Adressen: Im Beispiel wurde f√ºr <code>ldr r0</code>
ein 4 Byte gro√üer Op-Code angenommen plus 4 Byte f√ºr die Adresse <code>x</code>. F√ºr das <code>sub</code>
wurden dagegen 3x 4 Byte gebraucht (Op-Code, R0, R1).</p>
</div>
</div>
<h2 id="aufruf-von-funktionen">Aufruf von Funktionen</h2>
<p>Es soll Maschinencode f√ºr den folgenden Funktionsaufruf erzeugt werden:</p>
<pre><code>x = f(p1, ..., pn)
</code></pre>
<p>Dies k√∂nnte sich ungef√§hr in folgenden (fiktiven) Assembler-Code √ºbersetzen lassen:</p>
<div class='columns'>
<div class='column'>
<pre><code>    FP = SP             ;; Framepointer auf aktuellen Stackpointer setzen
    Stack[SP] = R       ;; R√ºcksprungadresse auf Stack
    Stack[SP-4] = p1    ;; Parameter p1 auf Stack
    ...
    Stack[SP-4*n] = pn  ;; Parameter pn auf Stack
    SP = SP - 4*(n+1)   ;; Stackpointer auf n√§chste freie Stelle
    Goto f              ;; Setze den PC auf die Adresse von f im Textsegment
R:  x = Stack[SP+4]     ;; Hole R√ºckgabewert
    SP = SP + 4         ;; Stackpointer auf n√§chste freie Stelle
</code></pre>
</div>
<div class='column'>
<p><a href="#R-image-30852d6365761308e409b5158418ddfc" class="lightbox-link"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/machinecode/f-stackframe.png?width=30%25&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: 30%;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-30852d6365761308e409b5158418ddfc"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/machinecode/f-stackframe.png?width=30%25&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
</div>
</div>
<h3 id="funktionsaufruf">Funktionsaufruf</h3>
<p>Ein Funktionsaufruf entspricht einem Sprung an die Stelle im
Textsegment, wo der Funktionscode abgelegt ist. Dies erreicht man, in
dem man diese Adresse in den <em>PC</em> schreibt. Bei einem <code>return</code> muss
man wieder zum urspr√ºnglichen Programmcode zur√ºckspringen, weshalb man
diese Adresse auf dem Stack hinterlegt.</p>
<h3 id="parameter">Parameter</h3>
<p>Zus√§tzlich m√ºssen Parameter f√ºr die Funktion auf dem Stack abgelegt
werden, damit die Funktion auf diese zugreifen kann. Im Funktionscode
greift man dann statt auf die Variablen auf die konkreten Adressen im
Stack-Frame zu. Dazu verwendet man den <em>Framepointer</em> bzw. <em>FP</em>, der
auf die Adresse des ersten Parameters, d.h. auf die Adresse <em>hinter</em>
der R√ºcksprungadresse, zeigt. Die Parameter sind dann je Funktion √ºber
konstante Offsets relativ zum <em>FP</em> erreichbar. √Ñhnlich wie die
R√ºcksprungadresse muss der <em>FP</em> des aufrufenden Kontexts im Stack-Frame
der aufgerufenen Funktion gesichert werden (in der Skizze nicht dargestellt)
und am Ende des Aufrufs wieder hergestellt werden.</p>
<h3 id="lokale-variablen">Lokale Variablen</h3>
<p>Lokale Variablen einer Funktion werden ebenfalls auf dem Stack
angelegt, falls nicht gen√ºgend Register zur Verf√ºgung stehen, und
relativ zum <em>FP</em> adressiert. Die Gr√∂√üe des daf√ºr verwendeten Speichers
wird oft als <em>Framesize</em> oder <em>Rahmengr√∂√üe</em> bezeichnet. Am Ende eines
Funktionsaufrufs wird dieser Speicher freigegeben indem der
<em>Stackpointer</em> bzw. <em>SP</em> auf den <em>FP</em> zur√ºckgesetzt wird.</p>
<p>Die Adressierung von Parametern und Variablen kann auch relativ zum
<em>SP</em> erfolgen, so dass kein <em>FP</em> ben√∂tigt wird. Der dazu erzeugte
Maschinencode kann aber deutlich komplexer sein, da Stack und <em>SP</em>
auch f√ºr arithmetische Berechnungen verwendet werden und der <em>SP</em>
somit f√ºr die Dauer eines Funktionsaufrufs nicht zwingend konstant
ist.</p>
<h3 id="r√ºckgabewerte">R√ºckgabewerte</h3>
<p>Falls eine Funktion R√ºckgabewerte hat, werden diese ebenfalls auf dem
Stack abgelegt (√úberschreiben der urspr√ºnglichen Parameter).</p>
<p>Zusammengefasst gibt es f√ºr jeden Funktionsaufruf die in der obigen
Skizze dargestellte Struktur (&quot;Stack Frame&quot; oder auch &quot;Activation
Record&quot; genannt):</p>
<ul>
<li>Funktionsparameter (falls vorhanden)</li>
<li>R√ºcksprungadresse (d.h. aktueller <em>PC</em>)</li>
<li>Lokale Variablen der Funktion (falls vorhanden)</li>
</ul>
<h3 id="sichern-von-lokalen-variablen-der-alten-funktion">Sichern von lokalen Variablen der &quot;alten&quot; Funktion</h3>
<ul>
<li>Vor Funktionsaufrufen m√ºssen aktuell verwendete Register (lokale Variablen) gesichert werden</li>
<li>Register werden in den Speicher (Stack) ausgelagert</li>
<li>Sicherung kann durch aufrufende Funktion (<em>Caller-Saves</em>) oder aufgerufene Funktion (<em>Callee-Saves</em>) erfolgen
<ul>
<li>Caller-Safes: nur &quot;lebende&quot; Register m√ºssen gesichert werden</li>
<li>Callee-Safes: nur tats√§chlich verwendete Register m√ºssen gesichert werden</li>
</ul>
</li>
<li>Nachteile: unn√∂tiges Sichern von Registern bei beiden Varianten m√∂glich</li>
<li>In der Praxis daher meist gemischter Ansatz aus Caller-Saves und Callee-Saves Registern</li>
</ul>
<h2 id="funktionsaufruf-prolog">Funktionsaufruf: Prolog</h2>
<pre><code>f:  ...                 ;; Label f: hier startet die Funktion
    p1 = Stack[SP+4*n]  ;; Zugriff auf p1 (per SP)
    p1 = Stack[FP-4]    ;; Zugriff auf p1 (per FP)
    ...                 ;; hier Funktionskram
</code></pre>
<p>Die Parameter einer Funktion werden vom aufrufenden Kontext auf dem Stack abgelegt. Nach dem Sprung
in die Funktion kann √ºber den Stack-Pointer oder den Frame-Pointer darauf zugegriffen werden. Alternativ
k√∂nnte man die Parameter auch in vorhandene Register laden und entsprechend den <em>SP</em> hochz√§hlen.</p>
<h2 id="funktionsaufruf-epilog">Funktionsaufruf: Epilog</h2>
<div class='columns'>
<div class='column'>
<pre><code>    SP = FP - 4             ;; Position √ºber R√ºcksprungadresse auf Stack
    FP = Stack[FP]          ;; Sichere R√ºcksprungadresse (R)
    Stack[SP+4] = Ergebnis  ;; Ergebnis auf Stack (statt R√ºcksprung-Adresse)
    Goto FP                 ;; Setze den PC auf die R√ºcksprung-Adresse
</code></pre>
</div>
<div class='column'>
<p><a href="#R-image-33cd645dcdf2c65f4d00fee6b02251ed" class="lightbox-link"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/machinecode/f-epilog.png?width=30%25&amp;height=auto" alt="" class="figure-image noborder lightbox noshadow" style="height: auto; width: 30%;" loading="lazy"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-33cd645dcdf2c65f4d00fee6b02251ed"><img src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/backend/machinecode/f-epilog.png?width=30%25&amp;height=auto" alt="" class="lightbox-image noborder lightbox noshadow" loading="lazy"></a></p>
</div>
</div>
<p>Beim R√ºcksprung aus einer Funktion wird der R√ºckgabewert an die Stelle der R√ºcksprungadresse
geschrieben und der restliche Stack freigegeben.</p>
<p>Der R√ºckgabewert wird dann vom Aufrufer an der Stelle <code>Stack[SP+4]</code> abgerufen und freigegeben
(siehe Beispiel oben).</p>
<p><em>Anmerkung</em>: Das Handling des <em>FP</em> ist im obigen Beispiel nicht konsistent bzw. vollst√§ndig.
Nach dem R√ºcksprung in den Aufrufer muss der <em>FP</em> auf die Speicheradresse im Stack zeigen, wo
die R√ºcksprungadresse dessen Aufrufers steht ...</p>
<h2 id="wrap-up">Wrap-Up</h2>
<p>Skizze zur Erzeugung von Assembler-Code</p>
<ul>
<li>Relativ √§hnlich wie die Erzeugung von Bytecode</li>
<li>Beachtung der Eigenschaften der Zielhardware (Register, Maschinenbefehle, ...)
<ul>
<li>√úbersetzen des Zwischencodes in Maschinenbefehle</li>
<li>Sammeln von Konstanten und Literalen am Ende vom Text-Segment</li>
<li>Aufl√∂sen von Adressen</li>
<li>Zuordnung der Variablen und Daten zu Registern oder Adressen</li>
<li>Aufruf von Funktionen: Op-Codes zum Anlegen der <em>Stack-Frames</em></li>
</ul>
</li>
</ul>


    



    



    





    




    
    
        
        

        
            
            
            
            
            

            
            
                
                    
                
            
            
            
            
            
            

            
            
                
            
            
                
                
                    
                
                
                    
                
            
            
                
            
            
        
    
    

    
<div class="box notices cstyle info">
  <div class="box-label"><i class="fas fa-book-reader"></i> Quellen</div>
  <div class="box-content">

<ul> <li id='id_Mogensen2017'>[Mogensen2017] <strong>Introduction to Compiler Design</strong><br>Mogensen, T., Springer, 2017. ISBN <a href='https://fhb-bielefeld.digibib.net/openurl?isbn=978-3-319-66966-3' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>978-3-319-66966-3</a>. DOI <a href='https://doi.org/10.1007/978-3-319-66966-3' class='icon reading' target='_blank' rel='nofollow noopener noreferrer'>10.1007/978-3-319-66966-3</a>.<br><em>Kapitel 7 Machine-Code Generation</em></li></ul></div>
</div>






<footer class="footline"><div style="color: darkgray; font-size: small;">
<p style="margin: 4rem;">
<!-- https://creativecommons.org/choose/ -->
<a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0;margin:0;display:inline;" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
Unless otherwise noted, <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master">this work</a> by <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/bcg7" property="cc:attributionName" rel="cc:attributionURL">BC George</a>, <a xmlns:cc="https://creativecommons.org/ns#" href="https://github.com/cagix" property="cc:attributionName" rel="cc:attributionURL">Carsten Gips</a>, and <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/graphs/contributors">contributors</a> is licensed under <a rel="license" href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/LICENSE.md">CC BY-SA 4.0</a>.
See the <a href="https://github.com/Compiler-CampusMinden/CB-Vorlesung-Master/blob/master/CREDITS.md">credits</a> for a detailed list of contributing projects.

</p>
</div>

</footer>
</article>

          </section>
        </div>
      </main>
    </div>
    <script src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/js/clipboard.min.js?1697015446" defer></script>
    <script src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/js/perfect-scrollbar.min.js?1697015446" defer></script>
    <script>
      function useMathJax( config ){
        if( !Object.assign ){
          
          return;
        }
        window.MathJax = Object.assign( window.MathJax || {}, {
          loader: {
            load: ['[tex]/mhchem']
          },
          startup: {
            elements: [
              '.math'
            ]
          },
          tex: {
            inlineMath: [
              ['$', '$'], 
              ['\\(', '\\)']
            ]
          },
          options: {
            enableMenu: false 
          }
        }, config );
      }
      useMathJax( JSON.parse("{}") );
    </script>
    <script id="MathJax-script" async src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/js/mathjax/tex-mml-chtml.js?1697015446"></script>
    <script src="https://www.hsbi.de/elearning/data/FH-Bielefeld/lm_data/lm_1371719/js/theme.js?1697015446" defer></script>
  </body>
</html>
